<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>Timo Pomodoro Timer</title>
<script src="js/auth.js"></script>
<script>
  // Check authentication
  if (!window.AuthUtils.requireAuth()) {
    // Redirect will happen automatically
  }
</script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jalali-moment/dist/jalali-moment.browser.js"></script>
<style>
  :root{ --bg1:#f6d365; --bg2:#fda085; --ink:#2d2d2d; }
  *{box-sizing:border-box}
  body{
    margin:0; padding:0; min-height:100vh; font-family:'Vazirmatn',sans-serif;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    transition:background 1s ease;
  }
  a.back-btn{position:fixed;right:22px;top:22px;background:rgba(0,0,0,.35);color:#fff;text-decoration:none;padding:8px 14px;border-radius:999px;font-weight:700}
  #date{color:#fff;font-size:20px;font-weight:700;margin-bottom:12px;text-shadow:0 2px 6px rgba(0,0,0,.25)}
  #modeBox{
    background:rgba(255,255,255,.92); color:var(--ink); font-weight:700; padding:8px 22px; border-radius:20px;
    box-shadow:0 5px 15px rgba(0,0,0,.2); margin-bottom:14px; font-size:18px
  }
  #timer{
    font-size:120px;font-weight:800;color:#333;background:rgba(255,255,255,.92);
    border-radius:24px;width:80%;max-width:520px;height:180px;display:flex;align-items:center;justify-content:center;
    box-shadow:0 12px 28px rgba(0,0,0,.28); margin-bottom:28px
  }
  .controls{display:flex;gap:14px;justify-content:center;align-items:center;flex-wrap:wrap}
  button{padding:10px 22px;border:none;border-radius:28px;font-size:16px;font-weight:800;color:#fff;background:#333;cursor:pointer;transition:.25s}
  button:hover{transform:scale(1.06);background:#000}
  #settings-icon{font-size:24px;color:#fff;cursor:pointer;margin-right:5px;transition:.3s}
  #settings-icon:hover{transform:rotate(90deg)}
  .settings-menu{display:none; position:absolute; bottom:96px; background:rgba(255,255,255,.96); border-radius:14px; box-shadow:0 10px 26px rgba(0,0,0,.25); padding:8px; white-space:nowrap}
  .settings-menu button{display:block;width:100%;margin:6px 0;background:#fda085;color:#fff}
  .btn-pill{border:none;background:#111827;color:#fff;border-radius:999px;padding:10px 16px;font-weight:800;display:inline-flex;gap:8px;align-items:center}

  /* Modals */
  .dim{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9}
  .modal-box{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; width:min(640px,92vw); border-radius:20px; overflow:hidden; box-shadow:0 24px 60px rgba(0,0,0,.35); z-index:10}
  .modal-head{padding:10px 14px; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; display:flex; align-items:center; justify-content:space-between}
  .modal-head.right{flex-direction:row-reverse}
  .close-soft{background:#fda085; color:#fff; border:none; border-radius:12px; padding:6px 12px; font-weight:800; cursor:pointer}
  .close-soft:hover,.close-soft:active,.close-soft:focus{background:#fda085;color:#fff;transform:none}
  .modal-body{padding:16px;max-height:70vh;overflow-y:auto;overflow-x:hidden}
  .modal-box input{margin:6px 0; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; width:100%; text-align:center}
  .rep-card{border:1px solid #eee;border-radius:16px;background:#fff;padding:12px}
  .rep-title{font-weight:800;margin-bottom:6px}

  .nohover, .nohover:hover, .nohover:active, .nohover:focus {
    background:#fda085 !important;
    color:#fff !important;
    border-color:#fda085 !important;
    transform:none !important;
    box-shadow:none !important;
    filter:none !important;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    body {
      padding: 20px 10px;
    }
    
    #date {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    #modeBox {
      font-size: 16px;
      padding: 6px 18px;
      margin-bottom: 12px;
    }
    
    #timer {
      font-size: 80px;
      width: 90%;
      max-width: 400px;
      height: 140px;
      margin-bottom: 20px;
    }
    
    .controls {
      gap: 10px;
      flex-wrap: wrap;
      max-width: 300px;
    }
    
    .controls button {
      flex: 1;
      min-width: calc(50% - 5px);
      max-width: calc(50% - 5px);
    }
    
    button {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 20px;
    }
    
    #settings-icon {
      font-size: 20px;
    }
    
    .settings-menu {
      bottom: 80px;
      padding: 6px;
    }
    
    .modal-box {
      width: 95vw;
      border-radius: 16px;
    }
    
    .modal-body {
      padding: 12px;
      max-height: 60vh;
    }
    
    .modal-box input {
      padding: 8px 10px;
      font-size: 14px;
    }
    
    .rep-card {
      padding: 10px;
      border-radius: 12px;
    }
    
    .rep-title {
      font-size: 14px;
    }
  }

  @media (max-width: 480px) {
    body {
      padding: 15px 5px;
    }
    
    #date {
      font-size: 14px;
    }
    
    #modeBox {
      font-size: 14px;
      padding: 5px 15px;
    }
    
    #timer {
      font-size: 60px;
      width: 95%;
      height: 120px;
      margin-bottom: 15px;
    }
    
    .controls {
      gap: 8px;
      max-width: 280px;
    }
    
    .controls button {
      flex: 1;
      min-width: calc(50% - 4px);
      max-width: calc(50% - 4px);
    }
    
    button {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 16px;
    }
    
    #settings-icon {
      font-size: 18px;
    }
    
    .settings-menu {
      bottom: 70px;
      padding: 4px;
    }
    
    .modal-box {
      width: 98vw;
      border-radius: 12px;
    }
    
    .modal-body {
      padding: 10px;
      max-height: 50vh;
    }
    
    .modal-box input {
      padding: 6px 8px;
      font-size: 13px;
    }
    
    .rep-card {
      padding: 8px;
    }
    
    .rep-title {
      font-size: 13px;
    }
  }
</style>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<meta name="theme-color" content="#f6d365">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>

<a href="index.html" class="back-btn">بازگشت</a>
<div id="date"></div>
<div id="modeBox">زمان مطالعه 📚</div>
<div id="timer">25:00</div>

<div class="controls">
  <button id="start">شروع</button>
  <button id="pause">توقف</button>
  <button id="reset">ریست</button>
  <button id="end">پایان</button>
  <div id="settings-icon">⚙️</div>
</div>

<div class="settings-menu" id="settings-menu">
  <button id="custom-time">⏱️ تنظیم زمان دلخواه</button>
  <button id="report">📊 گزارش‌گیری</button>
</div>

<!-- Custom Time -->
<div id="dim" class="dim"></div>
<div class="modal-box" id="customTimeModal">
  <div class="modal-head right">
    <button class="close-soft" onclick="closeModal('customTimeModal')">بستن</button>
    <strong>تنظیم زمان دلخواه</strong>
  </div>
  <div class="modal-body">
    <label class="form-label">زمان مطالعه (دقیقه)</label>
    <input type="number" id="studyTime" placeholder="مثلاً 25">
    <label class="form-label">زمان استراحت (دقیقه)</label>
    <input type="number" id="breakTime" placeholder="مثلاً 5">
    <button class="btn w-100 mt-2 nohover" style="background:#fda085;color:#fff" onclick="saveCustomTime()">ذخیره</button>
  </div>
</div>

<!-- Report -->
<div class="modal-box" id="reportModal">
  <div class="modal-head right">
    <button class="close-soft" onclick="closeModal('reportModal')">بستن</button>
    <strong>📊 گزارش‌گیری</strong>
  </div>
  <div class="modal-body">
    <p id="todayLine" class="mb-3 fw-bold">امروز ۰ دقیقه مطالعه کردی 📚</p>

    <div class="row g-2 align-items-end">
      <div class="col-12 col-sm-6">
        <label class="form-label">از (روز/ماه/سال)</label>
        <input type="text" id="fromDate" placeholder="مثلاً 10/07/1404">
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">تا (روز/ماه/سال)</label>
        <input type="text" id="toDate" placeholder="مثلاً 18/07/1404">
      </div>
    </div>

    <div class="d-flex gap-2 mt-3 flex-wrap">
      <button id="btnRange" class="btn-pill">🔎 مشاهده</button>
      <button id="btnDaily" class="btn-pill">📅 نمایش جزئیات روزانه</button>
    </div>
    <div id="errBox" class="mt-2 text-danger" style="display:none"></div>

    <div id="cards" class="mt-3" style="display:none">
      <div class="rep-card">
        <div class="rep-title">کل مطالعه در بازه</div>
        <div id="sumMinutes" class="fs-5 fw-bold">۰ دقیقه</div>
      </div>
      <div class="rep-card mt-2">
        <div class="rep-title">میانگین روزهای دارای مطالعه</div>
        <div id="avgMinutes" class="fs-5 fw-bold">۰ دقیقه</div>
      </div>
    </div>

    <div id="dailyBox" class="rep-card mt-3" style="display:none">
      <div class="rep-title">جزئیات روزانهٔ بازه</div>
      <div id="dailyList"></div>
    </div>
  </div>
</div>

<script>
  const showJalaliDate=()=>{document.getElementById('date').textContent=moment().locale('fa').format('dddd، D MMMM YYYY')};
  showJalaliDate();

  // کمک‌ها
  const todayKey = () => moment().format('jYYYY/jMM/jDD');

  async function apiGetTodayTotal() {
    const d = todayKey();
    const headers = window.AuthUtils.getAuthHeaders();
    if (!headers) {
      console.error('No token available for apiGetTodayTotal');
      return 0;
    }
    const r = await fetch(`/api/timer?date=${encodeURIComponent(d)}&t=${Date.now()}`, {
      headers: headers
    }).then(r=>r.json());
    return r.totalSeconds || 0;
  }
  async function apiAddSeconds(seconds, session) {
    console.log('=== API ADD SECONDS START ===');
    console.log('Raw parameters:', { seconds, session });
    console.log('Type of seconds:', typeof seconds);
    console.log('Value of seconds:', seconds);
    
    const d = todayKey();
    // همیشه sessionType را 'work' تنظیم کن
    const sessionType = 'work';
    console.log('SessionType set to:', sessionType);
    console.log('Date set to:', d);
    console.log('apiAddSeconds called with:', { seconds, session, sessionType });

    // بررسی که seconds معتبر باشد
    if (!seconds || seconds <= 0) {
      console.log('❌ No valid seconds to save, skipping API call');
      console.log('Seconds value:', seconds);
      console.log('Seconds type:', typeof seconds);
      return;
    }

    try {
      const headers = window.AuthUtils.getAuthHeaders();
      if (!headers) {
        console.error('❌ No token available for apiAddSeconds');
        throw new Error('No authentication token');
      }
      
      const requestData = { 
        date: d, 
        seconds: parseInt(seconds), // اطمینان از integer بودن
        sessionType: sessionType 
      };
      
      console.log('=== SENDING REQUEST ===');
      console.log('Request data:', requestData);
      console.log('Request data JSON:', JSON.stringify(requestData));
      console.log('Headers:', headers);
      
      const response = await fetch('/api/timer/addSeconds', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(requestData)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API error:', response.status, errorText);
        throw new Error(`API error: ${response.status} ${errorText}`);
      }
      
      const result = await response.json();
      console.log('Timer saved successfully:', result);
      return result;
    } catch (error) {
      console.error('Error in apiAddSeconds:', error);
      throw error;
    }
  }
  async function apiRange(fromYMD, toYMD) {
    console.log('apiRange called with:', { fromYMD, toYMD });
    const headers = window.AuthUtils.getAuthHeaders();
    if (!headers) {
      console.error('No token available for apiRange');
      return [];
    }
    
    try {
      const response = await fetch(`/api/timer/range?from=${encodeURIComponent(fromYMD)}&to=${encodeURIComponent(toYMD)}&t=${Date.now()}`, {
        headers: headers
      });
      
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('apiRange response:', data);
      
      // بررسی ساختار پاسخ
      if (data.timers && Array.isArray(data.timers)) {
        console.log('Returning timers array:', data.timers);
        return data.timers;
      } else if (Array.isArray(data)) {
        console.log('Returning data array:', data);
        return data;
      } else {
        console.log('No valid data structure, returning empty array');
        return [];
      }
    } catch (error) {
      console.error('apiRange error:', error);
      return [];
    }
  }

  // Timer
  let studyTime = 25*60, breakTime=5*60, remaining=studyTime, interval=null, isRunning=false, isStudy=true, sessionStart=null, accSeconds=0;
  let audioEnabled = false;

  // فعال کردن صدا در موبایل با اولین تعامل کاربر
  function enableAudio() {
    if (!audioEnabled) {
      audioEnabled = true;
      // ایجاد یک AudioContext خاموش برای فعال کردن صدا
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      if (ctx.state === 'suspended') {
        ctx.resume();
      }
    }
  }

  function setBg(isStudy){ document.body.style.background = isStudy ? 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)' : 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)'; }
  function updateTimer(){ const m=Math.floor(remaining/60), s=remaining%60; document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  function beep(freq=800, dur=300, isFinalBeep=false){
    try {
      // فعال کردن AudioContext در موبایل
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      
      // اگر AudioContext suspended است، آن را resume کن
      if (ctx.state === 'suspended') {
        ctx.resume().then(() => {
          playBeep(ctx, freq, dur, isFinalBeep);
        });
      } else {
        playBeep(ctx, freq, dur, isFinalBeep);
      }
    } catch (e) {
      console.log('Audio not supported:', e);
      // fallback: vibration در موبایل
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }
    }
  }
  
  function playBeep(ctx, freq, dur, isFinalBeep=false) {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g);
    g.connect(ctx.destination);
    o.type = 'sine';
    o.frequency.value = freq;
    // افزایش volume برای صدای نهایی
    g.gain.value = isFinalBeep ? 0.3 : 0.1;
    o.start();
    o.stop(ctx.currentTime + dur/1000);
  }

  function startTimer(){
    if(isRunning) return; isRunning=true;
    if(!sessionStart) sessionStart = new Date().toISOString();
    interval=setInterval(()=>{
      if(remaining>0){
        remaining--; updateTimer();
        accSeconds++;
        if(remaining<=3 && remaining>0) beep(900,180, false);
        if(remaining===0) beep(1200,800, true);
      } else {
        clearInterval(interval); isRunning=false;
        if(isStudy){
          // پایان فاز مطالعه ← ذخیره در سرور
          const endISO = new Date().toISOString();
          apiAddSeconds(accSeconds, null).then(updateTodayLine).catch(err => console.error('Error saving timer:', err));
          sessionStart = null; accSeconds = 0;

          isStudy=false; remaining=breakTime; document.getElementById('modeBox').textContent='زمان استراحت ☕'; setBg(false); toast('مطالعه تمام شد، استراحت کن ☕');
          updateTimer();
          // شروع خودکار فاز استراحت
          setTimeout(() => {
            if (!isRunning) { // اگر کاربر توقف نکرده باشد
              startTimer();
            }
          }, 2000); // 2 ثانیه تاخیر برای نمایش پیام
        } else {
          isStudy=true; remaining=studyTime; document.getElementById('modeBox').textContent='زمان مطالعه 📚'; setBg(true); toast('استراحت تمام شد، برگرد به مطالعه 📚');
          updateTimer();
          // شروع خودکار فاز مطالعه
          setTimeout(() => {
            if (!isRunning) { // اگر کاربر توقف نکرده باشد
              startTimer();
            }
          }, 2000); // 2 ثانیه تاخیر برای نمایش پیام
        }
      }
    },1000);
  }
  document.getElementById('start').onclick = () => {
    enableAudio();
    startTimer();
  };
  document.getElementById('pause').onclick = ()=>{
    enableAudio();
    clearInterval(interval); 
    if(!isRunning) return; 
    isRunning=false;
    if(isStudy && accSeconds>0){ 
      const endISO=new Date().toISOString(); 
      apiAddSeconds(accSeconds, null).then(updateTodayLine).catch(err => console.error('Error saving timer:', err)); 
    }
    sessionStart=null; accSeconds=0;
    toast('تایمر متوقف شد ⏸️');
  };
  document.getElementById('reset').onclick = ()=>{
    enableAudio();
    clearInterval(interval); 
    isRunning=false;
    if(isStudy && accSeconds>0){ 
      const endISO=new Date().toISOString(); 
      apiAddSeconds(accSeconds, null).then(updateTodayLine).catch(err => console.error('Error saving timer:', err)); 
    }
    sessionStart=null; accSeconds=0;

    isStudy=true; remaining=studyTime; document.getElementById('modeBox').textContent='زمان مطالعه 📚'; setBg(true); updateTimer();
    toast('تایمر ریست شد 🔄');
  };
  document.getElementById('end').onclick = ()=>{
    enableAudio();
    clearInterval(interval); 
    if(isStudy && accSeconds>0){ 
      const endISO=new Date().toISOString(); 
      apiAddSeconds(accSeconds, null).then(updateTodayLine).catch(err => console.error('Error saving timer:', err)); 
    }
    isRunning=false; sessionStart=null; accSeconds=0;
    
    // برگشت به حالت مطالعه (حتی اگر در استراحت باشیم)
    isStudy=true; 
    remaining=studyTime; 
    document.getElementById('modeBox').textContent='زمان مطالعه 📚'; 
    setBg(true); 
    updateTimer(); 
    toast('تایم مطالعه ثبت شد ✅');
  };
  updateTimer();

  function toast(text){ const el=document.createElement('div'); el.textContent=text; Object.assign(el.style,{position:'fixed',bottom:'28px',left:'50%',transform:'translateX(-50%)',background:'#333',color:'#fff',padding:'10px 20px',borderRadius:'22px',fontWeight:'700',boxShadow:'0 8px 18px rgba(0,0,0,.3)',zIndex:'9999',opacity:'0',transition:'opacity .4s'}); document.body.appendChild(el); setTimeout(()=>el.style.opacity='1',30); setTimeout(()=>{el.style.opacity='0'; setTimeout(()=>el.remove(),400)},2800); }

  const settingsIcon=document.getElementById('settings-icon'), settingsMenu=document.getElementById('settings-menu'), dim=document.getElementById('dim');
  settingsIcon.onclick=e=>{e.stopPropagation(); settingsMenu.style.display = settingsMenu.style.display==='block'?'none':'block';};
  document.addEventListener('click',e=>{ if(!settingsMenu.contains(e.target) && e.target!==settingsIcon) settingsMenu.style.display='none'; });

  document.getElementById('custom-time').onclick = e=>{e.stopPropagation(); settingsMenu.style.display='none'; openModal('customTimeModal');};
  document.getElementById('report').onclick      = e=>{e.stopPropagation(); settingsMenu.style.display='none'; openModal('reportModal'); updateTodayLine();};

  function openModal(id){ document.getElementById(id).style.display='block'; dim.style.display='block'; }
  function closeModal(id){ document.getElementById(id).style.display='none'; dim.style.display='none'; }
  dim.addEventListener('click',()=>{ ['customTimeModal','reportModal'].forEach(i=>document.getElementById(i).style.display='none'); dim.style.display='none'; });

  function saveCustomTime(){
    const s=parseInt(document.getElementById('studyTime').value), b=parseInt(document.getElementById('breakTime').value);
    if(s>0) studyTime=s*60; if(b>0) breakTime=b*60; remaining=studyTime; updateTimer(); toast('زمان جدید ذخیره شد ✅'); closeModal('customTimeModal');
  }

  // نمایش امروز (از سرور)
  async function updateTodayLine(){
    const secs = await apiGetTodayTotal();
    const mins = Math.floor(secs/60);
    document.getElementById('todayLine').textContent = `امروز ${mins} دقیقه مطالعه کردی 📚`;
  }
  updateTodayLine();

  // تاریخ مشترک گزارش
  const ERR_TXT='لطفاً تاریخ را با فرمت درست وارد کنید.';
  const keyDMY=(d,m,y)=>`${y}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`;
  const validDMY=s=>/^\d{2}\/\d{2}\/\d{4}$/.test(s)&&moment.from(keyDMY(...s.split('/').map(Number)),'fa','jYYYY/jMM/jDD').isValid();
  const DMYtoYMD=s=>{const [d,m,y]=s.split('/').map(Number); return keyDMY(d,m,y);};
  function validateRange(from,to){
    if(!validDMY(from)||!validDMY(to)) return null;
    const mFrom=moment.from(DMYtoYMD(from),'fa','jYYYY/jMM/jDD');
    const mTo  =moment.from(DMYtoYMD(to)  ,'fa','jYYYY/jMM/jDD');
    const today=moment();
    // حذف چک تاریخ آینده از اینجا - در کد اصلی چک می‌شود
    if(mTo.isBefore(mFrom)) return null;
    return {mFrom,mTo};
  }
  function showErr(msg){const e=document.getElementById('errBox'); e.style.display='block'; e.textContent=msg;}

  document.getElementById('btnRange').onclick=async()=>{
    const from=document.getElementById('fromDate').value.trim(), to=document.getElementById('toDate').value.trim();
    document.getElementById('errBox').style.display='none';
    
    // چک کردن تاریخ آینده قبل از validateRange
    const today = moment().format('jYYYY/jMM/jDD');
    console.log('Today:', today);
    console.log('From input:', from, 'To input:', to);
    
    // تبدیل تاریخ از DD/MM/YYYY به YYYY/MM/DD برای مقایسه
    const convertToJalali = (dateStr) => {
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const startJalali = convertToJalali(from);
    const endJalali = convertToJalali(to);
    const todayJalali = moment().format('jYYYY/jMM/jDD');
    
    console.log('Start jalali:', startJalali, 'End jalali:', endJalali);
    console.log('Today jalali:', todayJalali);
    
    // مقایسه مستقیم رشته‌های تاریخ شمسی
    const isStartFuture = startJalali > todayJalali;
    const isEndFuture = endJalali > todayJalali;
    
    console.log('Start > Today (string):', isStartFuture, 'End > Today (string):', isEndFuture);
    
    if (isStartFuture || isEndFuture) {
      console.log('Future date detected, showing error');
      showErr('❌ نمی‌توانید تاریخ آینده را انتخاب کنید! لطفاً فقط تاریخ‌های گذشته و امروز را انتخاب کنید.');
      document.getElementById('cards').style.display='none';
      document.getElementById('dailyBox').style.display='none';
      return;
    }
    
    console.log('Date validation passed, continuing...');
    
    const v=validateRange(from,to); if(!v){ showErr(ERR_TXT); document.getElementById('cards').style.display='none'; document.getElementById('dailyBox').style.display='none'; return; }

    // تبدیل فرمت تاریخ
    const convertDate = (dateStr) => {
      if (!dateStr) return dateStr;
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const convertedFrom = convertDate(from);
    const convertedTo = convertDate(to);

    const docs = await apiRange(convertedFrom, convertedTo);
    const sumSecs = docs.reduce((s,d)=>s+(d.duration||0), 0);
    
    // محاسبه روزهای دارای مطالعه (روزهایی که حداقل یک تایمر work دارند)
    const studyDates = new Set();
    docs.forEach(timer => {
      if (timer.sessionType === 'work' && (timer.duration || 0) > 0) {
        studyDates.add(timer.date);
      }
    });
    const daysWithStudy = studyDates.size;
    
    // فرمت زمان (بدون ثانیه)
    const formatTime = (seconds) => {
      if (!seconds || seconds === 0) return '00:00';
      const totalSeconds = Math.round(seconds);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      
      if (h === 0) {
        return `${String(m).padStart(2,'0')}:00`;
      } else {
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`;
      }
    };
    
    const totalTime = formatTime(sumSecs);
    const averageSeconds = daysWithStudy > 0 ? sumSecs / daysWithStudy : 0;
    
    // اگر میانگین کمتر از 1 دقیقه است، به صورت ثانیه نمایش بده
    let averageDisplay;
    if (averageSeconds < 60) {
      averageDisplay = `${Math.round(averageSeconds)} ثانیه`;
    } else {
      averageDisplay = formatTime(averageSeconds);
    }
    
    document.getElementById('sumMinutes').textContent = `${totalTime} مطالعه`;
    document.getElementById('avgMinutes').textContent = daysWithStudy ? `${averageDisplay} میانگین` : '۰ دقیقه';
    document.getElementById('cards').style.display='block';
    document.getElementById('dailyBox').style.display='none';
  };

  document.getElementById('btnDaily').onclick=async()=>{
    console.log('btnDaily clicked');
    const from=document.getElementById('fromDate').value.trim(), to=document.getElementById('toDate').value.trim();
    console.log('Date inputs for daily:', { from, to });
    document.getElementById('errBox').style.display='none';
    
    // چک کردن تاریخ آینده قبل از validateRange
    const today = moment().format('jYYYY/jMM/jDD');
    console.log('Today for daily:', today);
    console.log('From input daily:', from, 'To input daily:', to);
    
    // تبدیل تاریخ از DD/MM/YYYY به YYYY/MM/DD برای مقایسه
    const convertToJalali = (dateStr) => {
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const startJalali = convertToJalali(from);
    const endJalali = convertToJalali(to);
    const todayJalali = moment().format('jYYYY/jMM/jDD');
    
    console.log('Daily Start jalali:', startJalali, 'End jalali:', endJalali);
    console.log('Daily Today jalali:', todayJalali);
    
    // مقایسه مستقیم رشته‌های تاریخ شمسی
    const isStartFuture = startJalali > todayJalali;
    const isEndFuture = endJalali > todayJalali;
    
    console.log('Daily Start > Today (string):', isStartFuture, 'End > Today (string):', isEndFuture);
    
    if (isStartFuture || isEndFuture) {
      console.log('Future date detected in daily view, showing error');
      showErr('❌ نمی‌توانید تاریخ آینده را انتخاب کنید! لطفاً فقط تاریخ‌های گذشته و امروز را انتخاب کنید.');
      document.getElementById('cards').style.display='none';
      document.getElementById('dailyBox').style.display='none';
      return;
    }
    
    console.log('Daily date validation passed, continuing...');
    
    const v=validateRange(from,to); if(!v){ showErr(ERR_TXT); document.getElementById('dailyBox').style.display='none'; document.getElementById('cards').style.display='none'; return; }

    // تبدیل فرمت تاریخ
    const convertDate = (dateStr) => {
      if (!dateStr) return dateStr;
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const convertedFrom = convertDate(from);
    const convertedTo = convertDate(to);
    console.log('Converted dates for daily:', { from: convertedFrom, to: convertedTo });

    const docs = await apiRange(convertedFrom, convertedTo);
    console.log('Daily docs received:', docs);
    console.log('Number of docs:', docs.length);
    
    // گروه‌بندی بر اساس تاریخ و محاسبه مجموع
    const byDate = {};
    docs.forEach(timer => {
      const date = timer.date;
      const duration = timer.duration || 0;
      console.log(`Processing timer: date=${date}, duration=${duration}`);
      
      if (!byDate[date]) {
        byDate[date] = 0;
      }
      byDate[date] += duration;
    });
    
    console.log('Grouped by date:', byDate);
    console.log('Number of dates with data:', Object.keys(byDate).length);

    const list=document.getElementById('dailyList'); list.innerHTML='';
    const c=v.mFrom.clone();
    while(c.isSameOrBefore(v.mTo)){
      const k=c.format('jYYYY/jMM/jDD'); 
      const totalSeconds = byDate[k] || 0;
      
      // فرمت زمان بهتر (بدون ثانیه)
      let timeDisplay;
      if (totalSeconds < 60) {
        timeDisplay = `${totalSeconds} ثانیه`;
      } else {
        const mins = Math.floor(totalSeconds / 60);
        const hours = Math.floor(mins / 60);
        const remainingMins = mins % 60;
        
        if (hours === 0) {
          timeDisplay = `${mins} دقیقه`;
        } else {
          timeDisplay = `${hours}:${String(remainingMins).padStart(2,'0')} ساعت`;
        }
      }
      
      console.log(`Date ${k}: ${totalSeconds} seconds = ${timeDisplay}`);
      
      const row=document.createElement('div'); row.className='d-flex justify-content-between border-bottom py-2';
      row.innerHTML=`<span>${c.locale('fa').format('dddd jD jMMMM')}</span><strong>${timeDisplay}</strong>`;
      list.appendChild(row); c.add(1,'day');
    }
    document.getElementById('cards').style.display='none';
    document.getElementById('dailyBox').style.display='block';
  };

  // setupReportListener حذف شد - از کد قدیمی btnRange استفاده می‌شود
  function setupReportListener_DISABLED() {
    console.log('Setting up report listener...');
    const btnRange = document.getElementById('btnRange');
    console.log('btnRange element:', btnRange);
    if (btnRange) {
      console.log('Adding event listener to btnRange');
      btnRange.addEventListener('click', async function() {
    console.log('Report button clicked!');
    
    const start = document.getElementById('fromDate').value;
    const end = document.getElementById('toDate').value;
    
    console.log('Date inputs:', { start, end });
    
    if(!start || !end) {
      alert('لطفاً تاریخ شروع و پایان را انتخاب کنید');
      return;
    }
    
    // چک تاریخ آینده قبلاً انجام شده
    
    // تبدیل فرمت تاریخ از DD/MM/YYYY به YYYY/MM/DD
    const convertDate = (dateStr) => {
      if (!dateStr) return dateStr;
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        // تبدیل از DD/MM/YYYY به YYYY/MM/DD
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const convertedStart = convertDate(start);
    const convertedEnd = convertDate(end);
    
    console.log('Converted dates:', { from: convertedStart, to: convertedEnd });
    console.log('Report request:', { from: convertedStart, to: convertedEnd });
    
    try {
      const headers = window.AuthUtils.getAuthHeaders();
      if (!headers) {
        throw new Error('احراز هویت ناموفق');
      }
      
      console.log('Fetching timer range data...', { from: convertedStart, to: convertedEnd });

      const response = await fetch(`/api/timer/range?from=${encodeURIComponent(convertedStart)}&to=${encodeURIComponent(convertedEnd)}&t=${Date.now()}`, {
        headers: headers
      });
      
      if (!response.ok) {
        throw new Error(`خطای سرور: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Timer range response:', data);
      
      const formatTime = (seconds) => {
        console.log('Formatting time - input seconds:', seconds);
        
        // بررسی اگر seconds صفر یا undefined باشد
        if (!seconds || seconds === 0) {
          console.log('No time to format, returning 00:00');
          return '00:00';
        }
        
        const totalSeconds = Math.round(seconds);
        console.log('Total seconds:', totalSeconds);
        
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        
        console.log('Calculated - Hours:', h, 'Minutes:', m);
        
        if (h === 0) {
          const result = `${String(m).padStart(2,'0')}:00`;
          console.log('Result (MM:00):', result);
          return result;
        } else {
          const result = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`;
          console.log('Result (HH:MM:00):', result);
          return result;
        }
      };
      
      console.log('Raw data from API:', data);
      console.log('totalWork value:', data.totalWork);
      console.log('totalBreak value:', data.totalBreak);
      console.log('sessions value:', data.sessions);
      
      // تبدیل دقیقه به ثانیه برای formatTime
      const workTime = formatTime((data.totalWork || 0) * 60);
      const breakTime = formatTime((data.totalBreak || 0) * 60);
      const sessions = data.sessions || 0;
      
      console.log('Formatted workTime:', workTime);
      console.log('Formatted breakTime:', breakTime);
      console.log('Sessions count:', sessions);
      
      // محاسبه میانگین روزهای دارای مطالعه
      const totalWorkMinutes = data.totalWork || 0; // این در دقیقه است
      let daysWithStudy = data.daysWithStudy || 0; // تعداد روزهای دارای مطالعه
      
      // اگر daysWithStudy صفر است، از sessions استفاده کن (fallback)
      if (daysWithStudy === 0 && data.sessions > 0) {
        daysWithStudy = data.sessions;
        console.log('Using sessions as fallback for daysWithStudy:', daysWithStudy);
      }
      
      const averageMinutes = daysWithStudy > 0 ? totalWorkMinutes / daysWithStudy : 0;
      
      console.log('Debug average calculation:', {
        totalWorkMinutes,
        daysWithStudy,
        averageMinutes,
        dataTotalWork: data.totalWork,
        dataDaysWithStudy: data.daysWithStudy
      });
      
      // اگر میانگین کمتر از 1 دقیقه است، به صورت ثانیه نمایش بده
      let averageDisplay;
      if (averageMinutes < 1) {
        const averageSeconds = Math.round(averageMinutes * 60);
        averageDisplay = `${averageSeconds} ثانیه`;
      } else {
        // تبدیل دقیقه به ثانیه برای formatTime
        const averageSeconds = averageMinutes * 60;
        averageDisplay = formatTime(averageSeconds);
      }
      
      console.log('=== Average calculation FINAL ===');
      console.log('Total work minutes:', totalWorkMinutes);
      console.log('Days with study:', daysWithStudy);
      console.log('Average minutes:', averageMinutes);
      console.log('Average seconds:', averageMinutes * 60);
      console.log('Average display:', averageDisplay);
      console.log('=================================');
      
      console.log('Full API response:', data);
      
      // بررسی وجود عناصر DOM
      const sumMinutesEl = document.getElementById('sumMinutes');
      const avgMinutesEl = document.getElementById('avgMinutes');
      const cardsEl = document.getElementById('cards');
      const errBoxEl = document.getElementById('errBox');
      
      console.log('DOM elements found:', {
        sumMinutes: !!sumMinutesEl,
        avgMinutes: !!avgMinutesEl,
        cards: !!cardsEl,
        errBox: !!errBoxEl
      });
      
      if (sumMinutesEl) sumMinutesEl.textContent = `${workTime} مطالعه`;
      if (avgMinutesEl) avgMinutesEl.textContent = `${averageDisplay} میانگین`;
      if (cardsEl) cardsEl.style.display = 'block';
      if (errBoxEl) errBoxEl.style.display = 'none';
      
      console.log('Report displayed successfully:', { workTime, breakTime, sessions });
      
    } catch (error) {
      console.error('Report error:', error);
      document.getElementById('errBox').style.display = 'block';
      document.getElementById('errBox').textContent = `خطا: ${error.message}`;
    }
      });
    } else {
      console.error('btnRange element not found!');
    }
  }
  
  // setupReportListener غیرفعال شد
  // setupReportListener();
  // setTimeout(setupReportListener, 1000);
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .catch(err => console.log('SW register failed:', err));
    });
  }
</script>

</body>
</html>
