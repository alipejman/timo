<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>Timo Pomodoro Timer</title>
<script src="js/auth.js"></script>
<script>
  // Check authentication
  if (!window.AuthUtils.requireAuth()) {
    // Redirect will happen automatically
  }
</script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jalali-moment/dist/jalali-moment.browser.js"></script>
<style>
  :root{ --bg1:#f6d365; --bg2:#fda085; --ink:#2d2d2d; }
  *{box-sizing:border-box}
  body{
    margin:0; padding:0; min-height:100vh; font-family:'Vazirmatn',sans-serif;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    transition:background 1s ease;
  }
  a.back-btn{position:fixed;right:22px;top:22px;background:rgba(0,0,0,.35);color:#fff;text-decoration:none;padding:8px 14px;border-radius:999px;font-weight:700}
  #date{color:#fff;font-size:20px;font-weight:700;margin-bottom:12px;text-shadow:0 2px 6px rgba(0,0,0,.25)}
  #modeBox{
    background:rgba(255,255,255,.92); color:var(--ink); font-weight:700; padding:8px 22px; border-radius:20px;
    box-shadow:0 5px 15px rgba(0,0,0,.2); margin-bottom:14px; font-size:18px
  }
  #timer{
    font-size:120px;font-weight:800;color:#333;background:rgba(255,255,255,.92);
    border-radius:24px;width:80%;max-width:520px;height:180px;display:flex;align-items:center;justify-content:center;
    box-shadow:0 12px 28px rgba(0,0,0,.28); margin-bottom:28px
  }
  .controls{display:flex;gap:14px;justify-content:center;align-items:center;flex-wrap:wrap}
  button{padding:10px 22px;border:none;border-radius:28px;font-size:16px;font-weight:800;color:#fff;background:#333;cursor:pointer;transition:.25s}
  button:hover{transform:scale(1.06);background:#000}
  #settings-icon{font-size:24px;color:#fff;cursor:pointer;margin-right:5px;transition:.3s}
  #settings-icon:hover{transform:rotate(90deg)}
  .settings-menu{display:none; position:absolute; bottom:96px; background:rgba(255,255,255,.96); border-radius:14px; box-shadow:0 10px 26px rgba(0,0,0,.25); padding:8px; white-space:nowrap}
  .settings-menu button{display:block;width:100%;margin:6px 0;background:#fda085;color:#fff}
  .btn-pill{border:none;background:#111827;color:#fff;border-radius:999px;padding:10px 16px;font-weight:800;display:inline-flex;gap:8px;align-items:center}

  /* Modals */
  .dim{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9}
  .modal-box{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; width:min(640px,92vw); border-radius:20px; overflow:hidden; box-shadow:0 24px 60px rgba(0,0,0,.35); z-index:10}
  .modal-head{padding:10px 14px; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; display:flex; align-items:center; justify-content:space-between}
  .modal-head.right{flex-direction:row-reverse}
  .close-soft{background:#fda085; color:#fff; border:none; border-radius:12px; padding:6px 12px; font-weight:800; cursor:pointer}
  .close-soft:hover,.close-soft:active,.close-soft:focus{background:#fda085;color:#fff;transform:none}
  .modal-body{padding:16px;max-height:70vh;overflow-y:auto;overflow-x:hidden}
  .modal-box input{margin:6px 0; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; width:100%; text-align:center}
  .rep-card{border:1px solid #eee;border-radius:16px;background:#fff;padding:12px}
  .rep-title{font-weight:800;margin-bottom:6px}

  .nohover, .nohover:hover, .nohover:active, .nohover:focus {
    background:#fda085 !important;
    color:#fff !important;
    border-color:#fda085 !important;
    transform:none !important;
    box-shadow:none !important;
    filter:none !important;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    body {
      padding: 20px 10px;
    }
    
    #date {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    #modeBox {
      font-size: 16px;
      padding: 6px 18px;
      margin-bottom: 12px;
    }
    
    #timer {
      font-size: 80px;
      width: 90%;
      max-width: 400px;
      height: 140px;
      margin-bottom: 20px;
    }
    
    .controls {
      gap: 10px;
      flex-wrap: wrap;
      max-width: 300px;
    }
    
    .controls button {
      flex: 1;
      min-width: calc(50% - 5px);
      max-width: calc(50% - 5px);
    }
    
    button {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 20px;
    }
    
    #settings-icon {
      font-size: 20px;
    }
    
    .settings-menu {
      bottom: 80px;
      padding: 6px;
    }
    
    .modal-box {
      width: 95vw;
      border-radius: 16px;
    }
    
    .modal-body {
      padding: 12px;
      max-height: 60vh;
    }
    
    .modal-box input {
      padding: 8px 10px;
      font-size: 14px;
    }
    
    .rep-card {
      padding: 10px;
      border-radius: 12px;
    }
    
    .rep-title {
      font-size: 14px;
    }
  }

  @media (max-width: 480px) {
    body {
      padding: 15px 5px;
    }
    
    #date {
      font-size: 14px;
    }
    
    #modeBox {
      font-size: 14px;
      padding: 5px 15px;
    }
    
    #timer {
      font-size: 60px;
      width: 95%;
      height: 120px;
      margin-bottom: 15px;
    }
    
    .controls {
      gap: 8px;
      max-width: 280px;
    }
    
    .controls button {
      flex: 1;
      min-width: calc(50% - 4px);
      max-width: calc(50% - 4px);
    }
    
    button {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 16px;
    }
    
    #settings-icon {
      font-size: 18px;
    }
    
    .settings-menu {
      bottom: 70px;
      padding: 4px;
    }
    
    .modal-box {
      width: 98vw;
      border-radius: 12px;
    }
    
    .modal-body {
      padding: 10px;
      max-height: 50vh;
    }
    
    .modal-box input {
      padding: 6px 8px;
      font-size: 13px;
    }
    
    .rep-card {
      padding: 8px;
    }
    
    .rep-title {
      font-size: 13px;
    }
  }
</style>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<meta name="theme-color" content="#f6d365">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>

<a href="index.html" class="back-btn">Ø¨Ø§Ø²Ú¯Ø´Øª</a>
<div id="date"></div>
<div id="modeBox">Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ ğŸ“š</div>
<div id="timer">25:00</div>

<div class="controls">
  <button id="start">Ø´Ø±ÙˆØ¹</button>
  <button id="pause">ØªÙˆÙ‚Ù</button>
  <button id="reset">Ø±ÛŒØ³Øª</button>
  <button id="end">Ù¾Ø§ÛŒØ§Ù†</button>
  <div id="settings-icon">âš™ï¸</div>
</div>

<div class="settings-menu" id="settings-menu">
  <button id="custom-time">â±ï¸ ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ø¯Ù„Ø®ÙˆØ§Ù‡</button>
  <button id="report">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ</button>
</div>

<!-- Custom Time -->
<div id="dim" class="dim"></div>
<div class="modal-box" id="customTimeModal">
  <div class="modal-head right">
    <button class="close-soft" onclick="closeModal('customTimeModal')">Ø¨Ø³ØªÙ†</button>
    <strong>ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ø¯Ù„Ø®ÙˆØ§Ù‡</strong>
  </div>
  <div class="modal-body">
    <label class="form-label">Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø¯Ù‚ÛŒÙ‚Ù‡)</label>
    <input type="number" id="studyTime" placeholder="Ù…Ø«Ù„Ø§Ù‹ 25">
    <label class="form-label">Ø²Ù…Ø§Ù† Ø§Ø³ØªØ±Ø§Ø­Øª (Ø¯Ù‚ÛŒÙ‚Ù‡)</label>
    <input type="number" id="breakTime" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5">
    <button class="btn w-100 mt-2 nohover" style="background:#fda085;color:#fff" onclick="saveCustomTime()">Ø°Ø®ÛŒØ±Ù‡</button>
  </div>
</div>

<!-- Report -->
<div class="modal-box" id="reportModal">
  <div class="modal-head right">
    <button class="close-soft" onclick="closeModal('reportModal')">Ø¨Ø³ØªÙ†</button>
    <strong>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ</strong>
  </div>
  <div class="modal-body">
    <p id="todayLine" class="mb-3 fw-bold">Ø§Ù…Ø±ÙˆØ² Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯ÛŒ ğŸ“š</p>

    <div class="row g-2 align-items-end">
      <div class="col-12 col-sm-6">
        <label class="form-label">Ø§Ø² (Ø±ÙˆØ²/Ù…Ø§Ù‡/Ø³Ø§Ù„)</label>
        <input type="text" id="fromDate" placeholder="Ù…Ø«Ù„Ø§Ù‹ 10/07/1404">
      </div>
      <div class="col-12 col-sm-6">
        <label class="form-label">ØªØ§ (Ø±ÙˆØ²/Ù…Ø§Ù‡/Ø³Ø§Ù„)</label>
        <input type="text" id="toDate" placeholder="Ù…Ø«Ù„Ø§Ù‹ 18/07/1404">
      </div>
    </div>

    <div class="d-flex gap-2 mt-3 flex-wrap">
      <button id="btnRange" class="btn-pill">ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
      <button id="btnDaily" class="btn-pill">ğŸ“… Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø±ÙˆØ²Ø§Ù†Ù‡</button>
    </div>
    <div id="errBox" class="mt-2 text-danger" style="display:none"></div>

    <div id="cards" class="mt-3" style="display:none">
      <div class="rep-card">
        <div class="rep-title">Ú©Ù„ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø¯Ø± Ø¨Ø§Ø²Ù‡</div>
        <div id="sumMinutes" class="fs-5 fw-bold">Û° Ø¯Ù‚ÛŒÙ‚Ù‡</div>
      </div>
      <div class="rep-card mt-2">
        <div class="rep-title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¯Ø§Ø±Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡</div>
        <div id="avgMinutes" class="fs-5 fw-bold">Û° Ø¯Ù‚ÛŒÙ‚Ù‡</div>
      </div>
    </div>

    <div id="dailyBox" class="rep-card mt-3" style="display:none">
      <div class="rep-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ø±ÙˆØ²Ø§Ù†Ù‡Ù” Ø¨Ø§Ø²Ù‡</div>
      <div id="dailyList"></div>
    </div>
  </div>
</div>

<script>
  const showJalaliDate=()=>{document.getElementById('date').textContent=moment().locale('fa').format('ddddØŒ D MMMM YYYY')};
  showJalaliDate();

  // Ú©Ù…Ú©â€ŒÙ‡Ø§
  const todayKey = () => moment().format('jYYYY/jMM/jDD');

  async function apiGetTodayTotal() {
    const d = todayKey();
    const headers = window.AuthUtils.getAuthHeaders();
    if (!headers) {
      console.error('No token available for apiGetTodayTotal');
      return 0;
    }
    const r = await fetch(`/api/timer?date=${encodeURIComponent(d)}&t=${Date.now()}`, {
      headers: headers
    }).then(r=>r.json());
    return r.totalSeconds || 0;
  }
  async function apiAddSeconds(seconds, session) {
    console.log('=== API ADD SECONDS START ===');
    console.log('Raw parameters:', { seconds, session });
    console.log('Type of seconds:', typeof seconds);
    console.log('Value of seconds:', seconds);
    
    const d = todayKey();
    // Ù‡Ù…ÛŒØ´Ù‡ sessionType Ø±Ø§ 'work' ØªÙ†Ø¸ÛŒÙ… Ú©Ù†
    const sessionType = 'work';
    console.log('SessionType set to:', sessionType);
    console.log('Date set to:', d);
    console.log('apiAddSeconds called with:', { seconds, session, sessionType });

    // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ seconds Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯
    if (!seconds || seconds <= 0) {
      console.log('âŒ No valid seconds to save, skipping API call');
      console.log('Seconds value:', seconds);
      console.log('Seconds type:', typeof seconds);
      return;
    }

    try {
      const headers = window.AuthUtils.getAuthHeaders();
      if (!headers) {
        console.error('âŒ No token available for apiAddSeconds');
        throw new Error('No authentication token');
      }
      
      const requestData = { 
        date: d, 
        seconds: parseInt(seconds), // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² integer Ø¨ÙˆØ¯Ù†
        sessionType: sessionType 
      };
      
      console.log('=== SENDING REQUEST ===');
      console.log('Request data:', requestData);
      console.log('Request data JSON:', JSON.stringify(requestData));
      console.log('Headers:', headers);
      
      const response = await fetch('/api/timer/addSeconds', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(requestData)
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('API error:', response.status, errorText);
        throw new Error(`API error: ${response.status} ${errorText}`);
      }
      
      const result = await response.json();
      console.log('Timer saved successfully:', result);
      return result;
    } catch (error) {
      console.error('Error in apiAddSeconds:', error);
      throw error;
    }
  }
  async function apiRange(fromYMD, toYMD) {
    console.log('apiRange called with:', { fromYMD, toYMD });
    const headers = window.AuthUtils.getAuthHeaders();
    if (!headers) {
      console.error('No token available for apiRange');
      return [];
    }
    
    try {
      const response = await fetch(`/api/timer/range?from=${encodeURIComponent(fromYMD)}&to=${encodeURIComponent(toYMD)}&t=${Date.now()}`, {
        headers: headers
      });
      
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('apiRange response:', data);
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø§Ø³Ø®
      if (data.timers && Array.isArray(data.timers)) {
        console.log('Returning timers array:', data.timers);
        return data.timers;
      } else if (Array.isArray(data)) {
        console.log('Returning data array:', data);
        return data;
      } else {
        console.log('No valid data structure, returning empty array');
        return [];
      }
    } catch (error) {
      console.error('apiRange error:', error);
      return [];
    }
  }

  // Timer
  let studyTime = 25*60, breakTime=5*60, remaining=studyTime, interval=null, isRunning=false, isStudy=true, sessionStart=null, accSeconds=0;
  let audioEnabled = false;

  // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØµØ¯Ø§ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ Ø§ÙˆÙ„ÛŒÙ† ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±
  function enableAudio() {
    if (!audioEnabled) {
      audioEnabled = true;
      // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© AudioContext Ø®Ø§Ù…ÙˆØ´ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØµØ¯Ø§
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      if (ctx.state === 'suspended') {
        ctx.resume();
      }
    }
  }

  function setBg(isStudy){ document.body.style.background = isStudy ? 'linear-gradient(135deg, #f6d365 0%, #fda085 100%)' : 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)'; }
  function updateTimer(){ const m=Math.floor(remaining/60), s=remaining%60; document.getElementById('timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  function beep(freq=800, dur=300, isFinalBeep=false){
    try {
      // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† AudioContext Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      
      // Ø§Ú¯Ø± AudioContext suspended Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ resume Ú©Ù†
      if (ctx.state === 'suspended') {
        ctx.resume().then(() => {
          playBeep(ctx, freq, dur, isFinalBeep);
        });
      } else {
        playBeep(ctx, freq, dur, isFinalBeep);
      }
    } catch (e) {
      console.log('Audio not supported:', e);
      // fallback: vibration Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }
    }
  }
  
  function playBeep(ctx, freq, dur, isFinalBeep=false) {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g);
    g.connect(ctx.destination);
    o.type = 'sine';
    o.frequency.value = freq;
    // Ø§ÙØ²Ø§ÛŒØ´ volume Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
    g.gain.value = isFinalBeep ? 0.3 : 0.1;
    o.start();
    o.stop(ctx.currentTime + dur/1000);
  }

  function startTimer(){
    if(isRunning) return; isRunning=true;
    if(!sessionStart) sessionStart = new Date().toISOString();
    interval=setInterval(()=>{
      if(remaining>0){
        remaining--; updateTimer();
        accSeconds++;
        if(remaining<=3 && remaining>0) beep(900,180, false);
        if(remaining===0) beep(1200,800, true);
      } else {
        clearInterval(interval); isRunning=false;
        if(isStudy){
          // Ù¾Ø§ÛŒØ§Ù† ÙØ§Ø² Ù…Ø·Ø§Ù„Ø¹Ù‡ â† Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø³Ø±ÙˆØ±
          const endISO = new Date().toISOString();
          apiAddSeconds(accSeconds, null).then(updateTodayLine).catch(err => console.error('Error saving timer:', err));
          sessionStart = null; accSeconds = 0;

          isStudy=false; remaining=breakTime; document.getElementById('modeBox').textContent='Ø²Ù…Ø§Ù† Ø§Ø³ØªØ±Ø§Ø­Øª â˜•'; setBg(false); toast('Ù…Ø·Ø§Ù„Ø¹Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯ØŒ Ø§Ø³ØªØ±Ø§Ø­Øª Ú©Ù† â˜•');
          updateTimer();
          // Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ§Ø² Ø§Ø³ØªØ±Ø§Ø­Øª
          setTimeout(() => {
            if (!isRunning) { // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ØªÙˆÙ‚Ù Ù†Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
              startTimer();
            }
          }, 2000); // 2 Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
        } else {
          isStudy=true; remaining=studyTime; document.getElementById('modeBox').textContent='Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ ğŸ“š'; setBg(true); toast('Ø§Ø³ØªØ±Ø§Ø­Øª ØªÙ…Ø§Ù… Ø´Ø¯ØŒ Ø¨Ø±Ú¯Ø±Ø¯ Ø¨Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ ğŸ“š');
          updateTimer();
          // Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ§Ø² Ù…Ø·Ø§Ù„Ø¹Ù‡
          setTimeout(() => {
            if (!isRunning) { // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ØªÙˆÙ‚Ù Ù†Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
              startTimer();
            }
          }, 2000); // 2 Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
        }
      }
    },1000);
  }
  document.getElementById('start').onclick = () => {
    enableAudio();
    startTimer();
  };
  document.getElementById('pause').onclick = ()=>{
    enableAudio();
    clearInterval(interval); 
    if(!isRunning) return; 
    isRunning=false;
    if(isStudy && accSeconds>0){ 
      const endISO=new Date().toISOString(); 
      apiAddSeconds(accSeconds, null).then(updateTodayLine).catch(err => console.error('Error saving timer:', err)); 
    }
    sessionStart=null; accSeconds=0;
    toast('ØªØ§ÛŒÙ…Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯ â¸ï¸');
  };
  document.getElementById('reset').onclick = ()=>{
    enableAudio();
    clearInterval(interval); 
    isRunning=false;
    if(isStudy && accSeconds>0){ 
      const endISO=new Date().toISOString(); 
      apiAddSeconds(accSeconds, null).then(updateTodayLine).catch(err => console.error('Error saving timer:', err)); 
    }
    sessionStart=null; accSeconds=0;

    isStudy=true; remaining=studyTime; document.getElementById('modeBox').textContent='Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ ğŸ“š'; setBg(true); updateTimer();
    toast('ØªØ§ÛŒÙ…Ø± Ø±ÛŒØ³Øª Ø´Ø¯ ğŸ”„');
  };
  document.getElementById('end').onclick = ()=>{
    enableAudio();
    clearInterval(interval); 
    if(isStudy && accSeconds>0){ 
      const endISO=new Date().toISOString(); 
      apiAddSeconds(accSeconds, null).then(updateTodayLine).catch(err => console.error('Error saving timer:', err)); 
    }
    isRunning=false; sessionStart=null; accSeconds=0;
    
    // Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø­ØªÛŒ Ø§Ú¯Ø± Ø¯Ø± Ø§Ø³ØªØ±Ø§Ø­Øª Ø¨Ø§Ø´ÛŒÙ…)
    isStudy=true; 
    remaining=studyTime; 
    document.getElementById('modeBox').textContent='Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ ğŸ“š'; 
    setBg(true); 
    updateTimer(); 
    toast('ØªØ§ÛŒÙ… Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø«Ø¨Øª Ø´Ø¯ âœ…');
  };
  updateTimer();

  function toast(text){ const el=document.createElement('div'); el.textContent=text; Object.assign(el.style,{position:'fixed',bottom:'28px',left:'50%',transform:'translateX(-50%)',background:'#333',color:'#fff',padding:'10px 20px',borderRadius:'22px',fontWeight:'700',boxShadow:'0 8px 18px rgba(0,0,0,.3)',zIndex:'9999',opacity:'0',transition:'opacity .4s'}); document.body.appendChild(el); setTimeout(()=>el.style.opacity='1',30); setTimeout(()=>{el.style.opacity='0'; setTimeout(()=>el.remove(),400)},2800); }

  const settingsIcon=document.getElementById('settings-icon'), settingsMenu=document.getElementById('settings-menu'), dim=document.getElementById('dim');
  settingsIcon.onclick=e=>{e.stopPropagation(); settingsMenu.style.display = settingsMenu.style.display==='block'?'none':'block';};
  document.addEventListener('click',e=>{ if(!settingsMenu.contains(e.target) && e.target!==settingsIcon) settingsMenu.style.display='none'; });

  document.getElementById('custom-time').onclick = e=>{e.stopPropagation(); settingsMenu.style.display='none'; openModal('customTimeModal');};
  document.getElementById('report').onclick      = e=>{e.stopPropagation(); settingsMenu.style.display='none'; openModal('reportModal'); updateTodayLine();};

  function openModal(id){ document.getElementById(id).style.display='block'; dim.style.display='block'; }
  function closeModal(id){ document.getElementById(id).style.display='none'; dim.style.display='none'; }
  dim.addEventListener('click',()=>{ ['customTimeModal','reportModal'].forEach(i=>document.getElementById(i).style.display='none'); dim.style.display='none'; });

  function saveCustomTime(){
    const s=parseInt(document.getElementById('studyTime').value), b=parseInt(document.getElementById('breakTime').value);
    if(s>0) studyTime=s*60; if(b>0) breakTime=b*60; remaining=studyTime; updateTimer(); toast('Ø²Ù…Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…'); closeModal('customTimeModal');
  }

  // Ù†Ù…Ø§ÛŒØ´ Ø§Ù…Ø±ÙˆØ² (Ø§Ø² Ø³Ø±ÙˆØ±)
  async function updateTodayLine(){
    const secs = await apiGetTodayTotal();
    const mins = Math.floor(secs/60);
    document.getElementById('todayLine').textContent = `Ø§Ù…Ø±ÙˆØ² ${mins} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯ÛŒ ğŸ“š`;
  }
  updateTodayLine();

  // ØªØ§Ø±ÛŒØ® Ù…Ø´ØªØ±Ú© Ú¯Ø²Ø§Ø±Ø´
  const ERR_TXT='Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø¨Ø§ ÙØ±Ù…Øª Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
  const keyDMY=(d,m,y)=>`${y}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`;
  const validDMY=s=>/^\d{2}\/\d{2}\/\d{4}$/.test(s)&&moment.from(keyDMY(...s.split('/').map(Number)),'fa','jYYYY/jMM/jDD').isValid();
  const DMYtoYMD=s=>{const [d,m,y]=s.split('/').map(Number); return keyDMY(d,m,y);};
  function validateRange(from,to){
    if(!validDMY(from)||!validDMY(to)) return null;
    const mFrom=moment.from(DMYtoYMD(from),'fa','jYYYY/jMM/jDD');
    const mTo  =moment.from(DMYtoYMD(to)  ,'fa','jYYYY/jMM/jDD');
    const today=moment();
    // Ø­Ø°Ù Ú†Ú© ØªØ§Ø±ÛŒØ® Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ - Ø¯Ø± Ú©Ø¯ Ø§ØµÙ„ÛŒ Ú†Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯
    if(mTo.isBefore(mFrom)) return null;
    return {mFrom,mTo};
  }
  function showErr(msg){const e=document.getElementById('errBox'); e.style.display='block'; e.textContent=msg;}

  document.getElementById('btnRange').onclick=async()=>{
    const from=document.getElementById('fromDate').value.trim(), to=document.getElementById('toDate').value.trim();
    document.getElementById('errBox').style.display='none';
    
    // Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ø¢ÛŒÙ†Ø¯Ù‡ Ù‚Ø¨Ù„ Ø§Ø² validateRange
    const today = moment().format('jYYYY/jMM/jDD');
    console.log('Today:', today);
    console.log('From input:', from, 'To input:', to);
    
    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø§Ø² DD/MM/YYYY Ø¨Ù‡ YYYY/MM/DD Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡
    const convertToJalali = (dateStr) => {
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const startJalali = convertToJalali(from);
    const endJalali = convertToJalali(to);
    const todayJalali = moment().format('jYYYY/jMM/jDD');
    
    console.log('Start jalali:', startJalali, 'End jalali:', endJalali);
    console.log('Today jalali:', todayJalali);
    
    // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ… Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
    const isStartFuture = startJalali > todayJalali;
    const isEndFuture = endJalali > todayJalali;
    
    console.log('Start > Today (string):', isStartFuture, 'End > Today (string):', isEndFuture);
    
    if (isStartFuture || isEndFuture) {
      console.log('Future date detected, showing error');
      showErr('âŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ§Ø±ÛŒØ® Ø¢ÛŒÙ†Ø¯Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯! Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ Ùˆ Ø§Ù…Ø±ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
      document.getElementById('cards').style.display='none';
      document.getElementById('dailyBox').style.display='none';
      return;
    }
    
    console.log('Date validation passed, continuing...');
    
    const v=validateRange(from,to); if(!v){ showErr(ERR_TXT); document.getElementById('cards').style.display='none'; document.getElementById('dailyBox').style.display='none'; return; }

    // ØªØ¨Ø¯ÛŒÙ„ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®
    const convertDate = (dateStr) => {
      if (!dateStr) return dateStr;
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const convertedFrom = convertDate(from);
    const convertedTo = convertDate(to);

    const docs = await apiRange(convertedFrom, convertedTo);
    const sumSecs = docs.reduce((s,d)=>s+(d.duration||0), 0);
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¯Ø§Ø±Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø±ÙˆØ²Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ØªØ§ÛŒÙ…Ø± work Ø¯Ø§Ø±Ù†Ø¯)
    const studyDates = new Set();
    docs.forEach(timer => {
      if (timer.sessionType === 'work' && (timer.duration || 0) > 0) {
        studyDates.add(timer.date);
      }
    });
    const daysWithStudy = studyDates.size;
    
    // ÙØ±Ù…Øª Ø²Ù…Ø§Ù† (Ø¨Ø¯ÙˆÙ† Ø«Ø§Ù†ÛŒÙ‡)
    const formatTime = (seconds) => {
      if (!seconds || seconds === 0) return '00:00';
      const totalSeconds = Math.round(seconds);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      
      if (h === 0) {
        return `${String(m).padStart(2,'0')}:00`;
      } else {
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`;
      }
    };
    
    const totalTime = formatTime(sumSecs);
    const averageSeconds = daysWithStudy > 0 ? sumSecs / daysWithStudy : 0;
    
    // Ø§Ú¯Ø± Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ú©Ù…ØªØ± Ø§Ø² 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø«Ø§Ù†ÛŒÙ‡ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    let averageDisplay;
    if (averageSeconds < 60) {
      averageDisplay = `${Math.round(averageSeconds)} Ø«Ø§Ù†ÛŒÙ‡`;
    } else {
      averageDisplay = formatTime(averageSeconds);
    }
    
    document.getElementById('sumMinutes').textContent = `${totalTime} Ù…Ø·Ø§Ù„Ø¹Ù‡`;
    document.getElementById('avgMinutes').textContent = daysWithStudy ? `${averageDisplay} Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†` : 'Û° Ø¯Ù‚ÛŒÙ‚Ù‡';
    document.getElementById('cards').style.display='block';
    document.getElementById('dailyBox').style.display='none';
  };

  document.getElementById('btnDaily').onclick=async()=>{
    console.log('btnDaily clicked');
    const from=document.getElementById('fromDate').value.trim(), to=document.getElementById('toDate').value.trim();
    console.log('Date inputs for daily:', { from, to });
    document.getElementById('errBox').style.display='none';
    
    // Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ø¢ÛŒÙ†Ø¯Ù‡ Ù‚Ø¨Ù„ Ø§Ø² validateRange
    const today = moment().format('jYYYY/jMM/jDD');
    console.log('Today for daily:', today);
    console.log('From input daily:', from, 'To input daily:', to);
    
    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø§Ø² DD/MM/YYYY Ø¨Ù‡ YYYY/MM/DD Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡
    const convertToJalali = (dateStr) => {
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const startJalali = convertToJalali(from);
    const endJalali = convertToJalali(to);
    const todayJalali = moment().format('jYYYY/jMM/jDD');
    
    console.log('Daily Start jalali:', startJalali, 'End jalali:', endJalali);
    console.log('Daily Today jalali:', todayJalali);
    
    // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ… Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
    const isStartFuture = startJalali > todayJalali;
    const isEndFuture = endJalali > todayJalali;
    
    console.log('Daily Start > Today (string):', isStartFuture, 'End > Today (string):', isEndFuture);
    
    if (isStartFuture || isEndFuture) {
      console.log('Future date detected in daily view, showing error');
      showErr('âŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ§Ø±ÛŒØ® Ø¢ÛŒÙ†Ø¯Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯! Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ Ùˆ Ø§Ù…Ø±ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
      document.getElementById('cards').style.display='none';
      document.getElementById('dailyBox').style.display='none';
      return;
    }
    
    console.log('Daily date validation passed, continuing...');
    
    const v=validateRange(from,to); if(!v){ showErr(ERR_TXT); document.getElementById('dailyBox').style.display='none'; document.getElementById('cards').style.display='none'; return; }

    // ØªØ¨Ø¯ÛŒÙ„ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®
    const convertDate = (dateStr) => {
      if (!dateStr) return dateStr;
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const convertedFrom = convertDate(from);
    const convertedTo = convertDate(to);
    console.log('Converted dates for daily:', { from: convertedFrom, to: convertedTo });

    const docs = await apiRange(convertedFrom, convertedTo);
    console.log('Daily docs received:', docs);
    console.log('Number of docs:', docs.length);
    
    // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹
    const byDate = {};
    docs.forEach(timer => {
      const date = timer.date;
      const duration = timer.duration || 0;
      console.log(`Processing timer: date=${date}, duration=${duration}`);
      
      if (!byDate[date]) {
        byDate[date] = 0;
      }
      byDate[date] += duration;
    });
    
    console.log('Grouped by date:', byDate);
    console.log('Number of dates with data:', Object.keys(byDate).length);

    const list=document.getElementById('dailyList'); list.innerHTML='';
    const c=v.mFrom.clone();
    while(c.isSameOrBefore(v.mTo)){
      const k=c.format('jYYYY/jMM/jDD'); 
      const totalSeconds = byDate[k] || 0;
      
      // ÙØ±Ù…Øª Ø²Ù…Ø§Ù† Ø¨Ù‡ØªØ± (Ø¨Ø¯ÙˆÙ† Ø«Ø§Ù†ÛŒÙ‡)
      let timeDisplay;
      if (totalSeconds < 60) {
        timeDisplay = `${totalSeconds} Ø«Ø§Ù†ÛŒÙ‡`;
      } else {
        const mins = Math.floor(totalSeconds / 60);
        const hours = Math.floor(mins / 60);
        const remainingMins = mins % 60;
        
        if (hours === 0) {
          timeDisplay = `${mins} Ø¯Ù‚ÛŒÙ‚Ù‡`;
        } else {
          timeDisplay = `${hours}:${String(remainingMins).padStart(2,'0')} Ø³Ø§Ø¹Øª`;
        }
      }
      
      console.log(`Date ${k}: ${totalSeconds} seconds = ${timeDisplay}`);
      
      const row=document.createElement('div'); row.className='d-flex justify-content-between border-bottom py-2';
      row.innerHTML=`<span>${c.locale('fa').format('dddd jD jMMMM')}</span><strong>${timeDisplay}</strong>`;
      list.appendChild(row); c.add(1,'day');
    }
    document.getElementById('cards').style.display='none';
    document.getElementById('dailyBox').style.display='block';
  };

  // setupReportListener Ø­Ø°Ù Ø´Ø¯ - Ø§Ø² Ú©Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ btnRange Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  function setupReportListener_DISABLED() {
    console.log('Setting up report listener...');
    const btnRange = document.getElementById('btnRange');
    console.log('btnRange element:', btnRange);
    if (btnRange) {
      console.log('Adding event listener to btnRange');
      btnRange.addEventListener('click', async function() {
    console.log('Report button clicked!');
    
    const start = document.getElementById('fromDate').value;
    const end = document.getElementById('toDate').value;
    
    console.log('Date inputs:', { start, end });
    
    if(!start || !end) {
      alert('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
      return;
    }
    
    // Ú†Ú© ØªØ§Ø±ÛŒØ® Ø¢ÛŒÙ†Ø¯Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡
    
    // ØªØ¨Ø¯ÛŒÙ„ ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ø§Ø² DD/MM/YYYY Ø¨Ù‡ YYYY/MM/DD
    const convertDate = (dateStr) => {
      if (!dateStr) return dateStr;
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø² DD/MM/YYYY Ø¨Ù‡ YYYY/MM/DD
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return dateStr;
    };
    
    const convertedStart = convertDate(start);
    const convertedEnd = convertDate(end);
    
    console.log('Converted dates:', { from: convertedStart, to: convertedEnd });
    console.log('Report request:', { from: convertedStart, to: convertedEnd });
    
    try {
      const headers = window.AuthUtils.getAuthHeaders();
      if (!headers) {
        throw new Error('Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ø§Ù…ÙˆÙÙ‚');
      }
      
      console.log('Fetching timer range data...', { from: convertedStart, to: convertedEnd });

      const response = await fetch(`/api/timer/range?from=${encodeURIComponent(convertedStart)}&to=${encodeURIComponent(convertedEnd)}&t=${Date.now()}`, {
        headers: headers
      });
      
      if (!response.ok) {
        throw new Error(`Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Timer range response:', data);
      
      const formatTime = (seconds) => {
        console.log('Formatting time - input seconds:', seconds);
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ú¯Ø± seconds ØµÙØ± ÛŒØ§ undefined Ø¨Ø§Ø´Ø¯
        if (!seconds || seconds === 0) {
          console.log('No time to format, returning 00:00');
          return '00:00';
        }
        
        const totalSeconds = Math.round(seconds);
        console.log('Total seconds:', totalSeconds);
        
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        
        console.log('Calculated - Hours:', h, 'Minutes:', m);
        
        if (h === 0) {
          const result = `${String(m).padStart(2,'0')}:00`;
          console.log('Result (MM:00):', result);
          return result;
        } else {
          const result = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`;
          console.log('Result (HH:MM:00):', result);
          return result;
        }
      };
      
      console.log('Raw data from API:', data);
      console.log('totalWork value:', data.totalWork);
      console.log('totalBreak value:', data.totalBreak);
      console.log('sessions value:', data.sessions);
      
      // ØªØ¨Ø¯ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ formatTime
      const workTime = formatTime((data.totalWork || 0) * 60);
      const breakTime = formatTime((data.totalBreak || 0) * 60);
      const sessions = data.sessions || 0;
      
      console.log('Formatted workTime:', workTime);
      console.log('Formatted breakTime:', breakTime);
      console.log('Sessions count:', sessions);
      
      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¯Ø§Ø±Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡
      const totalWorkMinutes = data.totalWork || 0; // Ø§ÛŒÙ† Ø¯Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³Øª
      let daysWithStudy = data.daysWithStudy || 0; // ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø¯Ø§Ø±Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡
      
      // Ø§Ú¯Ø± daysWithStudy ØµÙØ± Ø§Ø³ØªØŒ Ø§Ø² sessions Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (fallback)
      if (daysWithStudy === 0 && data.sessions > 0) {
        daysWithStudy = data.sessions;
        console.log('Using sessions as fallback for daysWithStudy:', daysWithStudy);
      }
      
      const averageMinutes = daysWithStudy > 0 ? totalWorkMinutes / daysWithStudy : 0;
      
      console.log('Debug average calculation:', {
        totalWorkMinutes,
        daysWithStudy,
        averageMinutes,
        dataTotalWork: data.totalWork,
        dataDaysWithStudy: data.daysWithStudy
      });
      
      // Ø§Ú¯Ø± Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ú©Ù…ØªØ± Ø§Ø² 1 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø³ØªØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø«Ø§Ù†ÛŒÙ‡ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
      let averageDisplay;
      if (averageMinutes < 1) {
        const averageSeconds = Math.round(averageMinutes * 60);
        averageDisplay = `${averageSeconds} Ø«Ø§Ù†ÛŒÙ‡`;
      } else {
        // ØªØ¨Ø¯ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ formatTime
        const averageSeconds = averageMinutes * 60;
        averageDisplay = formatTime(averageSeconds);
      }
      
      console.log('=== Average calculation FINAL ===');
      console.log('Total work minutes:', totalWorkMinutes);
      console.log('Days with study:', daysWithStudy);
      console.log('Average minutes:', averageMinutes);
      console.log('Average seconds:', averageMinutes * 60);
      console.log('Average display:', averageDisplay);
      console.log('=================================');
      
      console.log('Full API response:', data);
      
      // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø§ØµØ± DOM
      const sumMinutesEl = document.getElementById('sumMinutes');
      const avgMinutesEl = document.getElementById('avgMinutes');
      const cardsEl = document.getElementById('cards');
      const errBoxEl = document.getElementById('errBox');
      
      console.log('DOM elements found:', {
        sumMinutes: !!sumMinutesEl,
        avgMinutes: !!avgMinutesEl,
        cards: !!cardsEl,
        errBox: !!errBoxEl
      });
      
      if (sumMinutesEl) sumMinutesEl.textContent = `${workTime} Ù…Ø·Ø§Ù„Ø¹Ù‡`;
      if (avgMinutesEl) avgMinutesEl.textContent = `${averageDisplay} Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†`;
      if (cardsEl) cardsEl.style.display = 'block';
      if (errBoxEl) errBoxEl.style.display = 'none';
      
      console.log('Report displayed successfully:', { workTime, breakTime, sessions });
      
    } catch (error) {
      console.error('Report error:', error);
      document.getElementById('errBox').style.display = 'block';
      document.getElementById('errBox').textContent = `Ø®Ø·Ø§: ${error.message}`;
    }
      });
    } else {
      console.error('btnRange element not found!');
    }
  }
  
  // setupReportListener ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯
  // setupReportListener();
  // setTimeout(setupReportListener, 1000);
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .catch(err => console.log('SW register failed:', err));
    });
  }
</script>

</body>
</html>
