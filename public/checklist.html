<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<title>Timo Checklist</title>
<script src="js/auth.js?v=20251016190000"></script>
<script>
  // Check authentication
  if (!window.AuthUtils.requireAuth()) {
    // Redirect will happen automatically
  }
</script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jalali-moment/dist/jalali-moment.browser.js"></script>
<style>
  :root{
    --bg1:#f6d365; --bg2:#fda085;
    --ink:#2a2a2a; --card:rgba(255,255,255,.96); --ring:rgba(0,0,0,.08);
    --chip:#f3f4f6; --chip-b:#e5e7eb; --ok:#10b981; --warn:#f59e0b; --del:#ef4444; --def:#6366f1;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:'Vazirmatn',sans-serif}
  a.back-btn{position:fixed;right:22px;top:22px;background:rgba(0,0,0,.35);color:#fff;text-decoration:none;padding:8px 14px;border-radius:999px;font-weight:700}
  #date{text-align:center;color:#fff;font-weight:800;margin-top:30px;text-shadow:0 2px 10px rgba(0,0,0,.25)}
  .wrap{width:min(920px,92vw);margin:90px auto 60px}
  .cardx{background:var(--card);border-radius:28px;box-shadow:0 18px 40px rgba(0,0,0,.25);padding:20px}
  .topbar{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
  .group{display:flex;align-items:center;gap:8px}
  .btn-pill{border:none;background:#1f2937;color:#fff;border-radius:999px;padding:10px 16px;font-weight:800;display:flex;align-items:center;gap:8px;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.18)}
  .progress-outer{background:#eee;border-radius:16px;height:20px;overflow:hidden}
  .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,#f6d365,#fda085);transition:width .2s}
  .badge-soft{background:#00000010;border:1px solid #00000015;padding:2px 8px;border-radius:999px;font-size:12px;color:#555}
  ul#list{list-style:none;margin:12px 0 0;padding:0}
  li.task{display:flex;align-items:center;gap:10px;padding:12px;border-radius:16px;border:1px dashed #eee;background:#fff;margin-bottom:10px}
  li.task.done{opacity:.5}
  .check{appearance:none;width:22px;height:22px;border:2px solid #777;border-radius:6px;cursor:pointer;position:relative;flex:0 0 22px}
  .check:checked{border-color:transparent;background:linear-gradient(135deg,#34d399,#10b981)}
  .check:checked::after{content:"✓";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:15px}
  .txt{flex:1;border:none;outline:none;background:transparent;font-size:16px;color:var(--ink);padding:6px 10px}
  .del{border:none;background:transparent;cursor:pointer;font-size:18px;opacity:.75}
  .del:hover{opacity:1;transform:translateY(-1px)}

  /* Modals */
  .dim{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9}
  .modalx{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;width:min(820px,94vw);max-height:88vh;border-radius:26px;overflow:hidden;box-shadow:0 28px 60px rgba(0,0,0,.45);background:#fff}
  .modal-head{padding:12px 16px;background:linear-gradient(110deg,var(--bg1),var(--bg2));color:#fff;display:flex;align-items:center;justify-content:space-between}
  .modal-head.right{flex-direction:row-reverse}
  .close-soft{background:#fda085;color:#fff;border:none;border-radius:12px;padding:6px 12px;font-weight:800;cursor:pointer}
  .close-soft:hover,.close-soft:active,.close-soft:focus{background:#fda085;color:#fff} /* ثابت بماند */
  .modal-body{padding:16px;max-height:calc(88vh - 56px);overflow:auto}
  .modal-card{border:1px solid var(--ring);background:#ffffffcc;border-radius:18px;padding:12px}
  .chip{background:var(--chip);border:1px solid var(--chip-b);border-radius:999px;padding:4px 10px;display:inline-flex;align-items:center;gap:6px;font-size:12px;cursor:default;position:relative}
  .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
  .dot-ok{background:var(--ok)} .dot-warn{background:var(--warn)} .dot-del{background:var(--del)} .dot-def{background:var(--def)}
  .stat-row{display:flex;align-items:center;gap:10px;margin-top:8px}
  .bar-mini{flex:1;height:8px;border-radius:999px;background:#eee;overflow:hidden}
  .bar-mini>span{display:block;height:100%;width:0%}
  .bm-ok{background:linear-gradient(90deg,#34d399,#10b981)}
  .bm-warn{background:linear-gradient(90deg,#fbbf24,#f59e0b)}
  .bm-del{background:linear-gradient(90deg,#fca5a5,#ef4444)}
  .bm-def{background:linear-gradient(90deg,#a5b4fc,#6366f1)}
  .day-card{border:1px solid #eaeaea;background:#fff;border-radius:16px;padding:12px;margin-top:12px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
  .day-title{display:flex;justify-content:space-between;align-items:center;font-weight:800}
  .mini{font-size:12px;color:#6b7280}

  /* Tooltip floating */
  .tooltipx{position:fixed;z-index:9999;background:#111827;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px;max-width:60vw;box-shadow:0 8px 18px rgba(0,0,0,.3);display:none;white-space:normal;line-height:1.6}

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .wrap {
      width: 95vw;
      margin: 60px auto 40px;
      padding: 0 10px;
    }
    
    .cardx {
      padding: 16px;
      border-radius: 20px;
    }
    
    .topbar {
      flex-direction: column;
      gap: 15px;
      align-items: stretch;
    }
    
    .group {
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn-pill {
      padding: 8px 14px;
      font-size: 14px;
    }
    
    .progress-outer {
      height: 16px;
    }
    
    li.task {
      padding: 10px;
      gap: 8px;
    }
    
    .check {
      width: 20px;
      height: 20px;
    }
    
    .txt {
      font-size: 14px;
      padding: 4px 8px;
    }
    
    .del {
      font-size: 16px;
    }
    
    .modalx {
      width: 95vw;
      max-height: 90vh;
      border-radius: 20px;
    }
    
    .modal-body {
      padding: 12px;
    }
    
    .modal-card {
      padding: 10px;
      border-radius: 14px;
    }
    
    .chip {
      padding: 3px 8px;
      font-size: 11px;
    }
    
    .day-card {
      padding: 10px;
      border-radius: 12px;
    }
    
    .stat-row {
      gap: 8px;
    }
    
    .bar-mini {
      height: 6px;
    }
    
    .mini {
      font-size: 11px;
    }
  }

  @media (max-width: 480px) {
    .wrap {
      width: 98vw;
      margin: 50px auto 30px;
      padding: 0 5px;
    }
    
    .cardx {
      padding: 12px;
      border-radius: 16px;
    }
    
    .topbar {
      gap: 12px;
    }
    
    .btn-pill {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    li.task {
      padding: 8px;
      gap: 6px;
    }
    
    .check {
      width: 18px;
      height: 18px;
    }
    
    .txt {
      font-size: 13px;
      padding: 3px 6px;
    }
    
    .modalx {
      width: 98vw;
      border-radius: 16px;
    }
    
    .modal-body {
      padding: 10px;
    }
    
    .day-card {
      padding: 8px;
    }
    
    .chip {
      padding: 2px 6px;
      font-size: 10px;
    }
  }
</style>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<meta name="theme-color" content="#f6d365">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>
  <a class="back-btn" href="index.html">بازگشت</a>
  <div id="date"></div>

  <div class="wrap">
    <div class="cardx">
      <div class="topbar">
        <div class="group">
          <button id="add" class="btn-pill">➕ کار جدید</button>
          <button id="reportBtn" class="btn-pill">📊 گزارش‌گیری</button>
        </div>
        <div style="min-width:320px">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="fw-bold">پیشرفت امروز</span>
            <span id="progressPercent" class="badge-soft">0%</span>
          </div>
          <div class="progress-outer"><div id="bar" class="progress-inner"></div></div>
        </div>
      </div>

      <ul id="list"></ul>
      <div id="emptyHint" class="text-center text-muted" style="display:none">فعلاً کاری باقی نمانده ✨</div>
    </div>
  </div>

  <!-- گزارش -->
  <div id="dim" class="dim"></div>
  <div id="reportModal" class="modalx">
    <div class="modal-head right">
      <button class="close-soft" onclick="closeReport()">بستن</button>
      <strong>📊 گزارش‌گیری چک‌لیست</strong>
    </div>
    <div class="modal-body">
      <!-- فیلتر تاریخ: بدون کادر مستطیلی -->
      <div>
        <div class="row g-2 align-items-end">
          <div class="col-12 col-sm-6">
            <label class="form-label">از (روز/ماه/سال)</label>
            <input id="fromDate" type="text" class="form-control" placeholder="مثلاً 05/07/1404">
          </div>
          <div class="col-12 col-sm-6">
            <label class="form-label">تا (روز/ماه/سال)</label>
            <input id="toDate" type="text" class="form-control" placeholder="مثلاً 08/07/1404">
          </div>
        </div>
        <div class="d-flex gap-2 mt-3 flex-wrap">
          <button id="rangeBtn" class="btn-pill">🔎 مشاهده</button>
          <button id="dailyBtn" class="btn-pill">📅 نمایش جزئیات روزانه</button>
        </div>
        <div id="errBox" class="mt-2 text-danger" style="display:none"></div>
      </div>

      <!-- خلاصهٔ بازه -->
      <div id="rangeResult" class="modal-card mt-3" style="display:none">
        <div class="fw-bold mb-2">نتیجه‌ی کلی بازه</div>
        <div id="rangeSummary" class="d-flex flex-wrap gap-2"></div>
        <div class="stat-row"><span class="chip"><span class="dot dot-ok"></span>انجام‌شده</span><div class="bar-mini"><span id="bmOk" class="bm-ok"></span></div><span id="bmOkTxt" class="mini">0%</span></div>
        <div class="stat-row"><span class="chip"><span class="dot dot-warn"></span>انجام‌نشده</span><div class="bar-mini"><span id="bmWarn" class="bm-warn"></span></div><span id="bmWarnTxt" class="mini">0%</span></div>
        <div class="stat-row"><span class="chip"><span class="dot dot-del"></span>حذف‌شده</span><div class="bar-mini"><span id="bmDel" class="bm-del"></span></div><span id="bmDelTxt" class="mini">0%</span></div>
        <div class="stat-row"><span class="chip"><span class="dot dot-def"></span>موکول‌شده</span><div class="bar-mini"><span id="bmDef" class="bm-def"></span></div><span id="bmDefTxt" class="mini">0%</span></div>
      </div>

      <!-- جزئیات روزانه -->
      <div id="dailyResult" class="modal-card mt-3" style="display:none">
        <div class="fw-bold mb-2">جزئیات روزانهٔ بازه</div>
        <div id="dailyLists"></div>
      </div>
    </div>
  </div>

  <!-- مودال نمایش جزئیات آیتم‌ها (کلیک روی چیپ‌ها) -->
  <div id="itemsModal" class="modalx" style="max-width:640px">
    <div class="modal-head right">
      <button class="close-soft" onclick="closeItems()">بستن</button>
      <strong id="itemsTitle">جزئیات</strong>
    </div>
    <div class="modal-body" id="itemsBody"></div>
  </div>

  <!-- تولتیپ مشترک -->
  <div class="tooltipx" id="tooltipx"></div>

<script>
  // تاریخ
  const showJalaliDate=()=>{document.getElementById('date').textContent=moment().locale('fa').format('dddd، D MMMM YYYY')};
  showJalaliDate(); setInterval(showJalaliDate,30000);

  // کلیدها و storage
  const todayKey = () => moment().format('jYYYY/jMM/jDD');
  const keyFor   = ymd => `tasks-${ymd}`;
  const delKey   = ymd => `deleted-${ymd}`;
  const defKey   = ymd => `postponed-${ymd}`;
  const rollKey  = ymd => `carry-done-${ymd}`;
  // توابع گزارش‌گیری - استفاده از API به جای localStorage
  async function apiGet(d) {
    const headers = window.AuthUtils.getAuthHeaders();
    if (!headers) {
      console.error('No token available for apiGet');
      return { items: [] };
    }
    const res = await fetch(`/api/checklist?date=${encodeURIComponent(d)}&t=${Date.now()}`, {
      headers: headers
    });
    if (!res.ok) throw new Error('get_failed');
    return res.json();
  }
  
  const read = async (ymd=todayKey()) => {
    try {
      const response = await apiGet(ymd);
      return response && response.items ? response.items : [];
    } catch (error) {
      console.error('Error reading from API:', error);
      return [];
    }
  };
  
  const readDeleted = async (ymd=todayKey()) => {
    // در حال حاضر حذف‌شده‌ها در API ذخیره نمی‌شوند
    return [];
  };
  
  const readPostponed = async (ymd=todayKey()) => {
    // در حال حاضر موکول‌شده‌ها در API ذخیره نمی‌شوند
    return [];
  };
  
  // توابع localStorage برای سازگاری (غیرفعال)
  const write=(items,ymd=todayKey())=>{}; // غیرفعال
  const addDeleted=(item,ymd=todayKey())=>{}; // غیرفعال
  const addPostponed=(arr,ymd=todayKey())=>{}; // غیرفعال

  // UI tasks
  const list=document.getElementById('list');
  function makeItem(d={id:crypto.randomUUID(),text:'',done:false}){
    // تبدیل _id به id برای سازگاری
    const itemId = d._id || d.id || crypto.randomUUID();
    const li=document.createElement('li');li.className='task'+(d.done?' done':'');li.dataset.id=itemId;
    const cb=document.createElement('input');cb.type='checkbox';cb.className='check';cb.checked=!!d.done;
    const input=document.createElement('input');input.type='text';input.className='txt';input.placeholder='اینجا بنویس…';input.value=d.text||'';
    const del=document.createElement('button');del.className='del';del.title='حذف';del.innerHTML='🗑️';
    li.appendChild(cb);li.appendChild(input);li.appendChild(del);
    cb.addEventListener('change',()=>{li.classList.toggle('done',cb.checked);
      if(cb.checked){list.appendChild(li);}else{const firstDone=[...list.children].find(x=>x.classList.contains('done')); if(firstDone) list.insertBefore(li,firstDone); else list.insertBefore(li,list.firstChild);}
      save();refreshProgress();updateEmptyHint();
    });
    input.addEventListener('input',()=>{debounceSave();updateEmptyHint();});
    del.addEventListener('click',()=>{const item={id:li.dataset.id,text:input.value.trim(),done:cb.checked}; addDeleted(item); li.remove(); save(); refreshProgress(); updateEmptyHint();});
    return li;
  }
  const collect=()=>{
    const allItems = [...list.children]
      .map(li=>({id:li.dataset.id,text:li.querySelector('.txt').value.trim(),done:li.querySelector('.check').checked}));
    
    console.log('Collect - All items from DOM:', allItems);
    
    // فیلتر کردن آیتم‌های خالی (فقط برای سینک)
    const filteredItems = allItems.filter(item => item.text.length > 0);
    console.log('Collect - Filtered items (non-empty):', filteredItems);
    
    return filteredItems;
  };

  // ⬇⬇⬇ فقط localStorage، هیچ سینک خودکار
  const save=()=>{ 
    // فقط localStorage، هیچ سینک خودکار
    console.log('Local save only - no auto-sync');
  };

  let t=null; const debounceSave=()=>{clearTimeout(t);t=setTimeout(save,260)};
  const refreshProgress=()=>{const items=collect();const total=items.length,done=items.filter(i=>i.done).length;const p= total? Math.round(done/total*100):0;document.getElementById('bar').style.width=p+'%';document.getElementById('progressPercent').textContent=p+'%';};
  const updateEmptyHint=()=>{const items=[...list.children];const allDone=items.length>0 && items.every(li=>li.classList.contains('done')||!li.querySelector('.txt').value.trim());document.getElementById('emptyHint').style.display=allDone?'block':'none';};
  // استراتژی جدید: فقط از دیتابیس
  function bootstrapToday(){ 
    console.log('Bootstrap disabled - using database only');
    // هیچ bootstrap نداشته باشیم
  }
  
  // تابع برای رندر آیتم‌ها از سرور
  function refreshUI(items) {
    console.log('refreshUI called with items:', items);
    if (!items || !Array.isArray(items)) {
      console.log('No valid items provided to refreshUI');
      return;
    }
    
    // اگر آیتمی وجود ندارد، پیام نمایش بده
    if (items.length === 0) {
      list.innerHTML = '<div class="empty-message" style="text-align: center; padding: 20px; color: #666;">هیچ وظیفه‌ای موجود نیست</div>';
      refreshProgress();
      updateEmptyHint();
      console.log('No items found, showing empty message');
      return;
    }
    
    // پاک کردن لیست فعلی
    list.innerHTML = '';
    
    // اضافه کردن آیتم‌های جدید
    items.forEach(item => {
      // تبدیل completed به done برای سازگاری
      const normalizedItem = {
        id: item._id || item.id,
        text: item.text || '',
        done: item.completed || item.done || false
      };
      const li = makeItem(normalizedItem);
      list.appendChild(li);
    });
    
    // مرتب کردن: آیتم‌های انجام نشده بالا، انجام شده پایین
    [...list.children].filter(li => li.classList.contains('done')).forEach(li => list.appendChild(li));
    
    refreshProgress();
    updateEmptyHint();
    console.log('refreshUI completed, items rendered:', items.length);
  }
  
  // در دسترس قرار دادن تابع refreshUI
  window.refreshUI = refreshUI;
  
  bootstrapToday();
  document.getElementById('add').addEventListener('click',()=>{const li=makeItem(); list.insertBefore(li,[...list.children].find(x=>x.classList.contains('done'))||null); li.querySelector('.txt').focus(); save(); refreshProgress();});

  // سینک قبل از بازگشت به صفحه اصلی
  const backLink = document.querySelector('a.back-btn');
  if (backLink) {
    backLink.addEventListener('click', async (ev) => {
      try {
        ev.preventDefault();
        if (window.AuthUtils && window.AuthUtils.isAuthenticated && window.AuthUtils.isAuthenticated()) {
          await (window.timoSyncChecklist ? window.timoSyncChecklist() : Promise.resolve());
        }
      } finally {
        window.location.href = backLink.getAttribute('href');
      }
    });
  }

  // Report modal
  const dim=document.getElementById('dim'), reportModal=document.getElementById('reportModal');
  document.getElementById('reportBtn').addEventListener('click',()=>{reportModal.style.display='block';dim.style.display='block';});
  function closeReport(){reportModal.style.display='none';dim.style.display='none';}
  window.closeReport=closeReport; dim.addEventListener('click',closeReport);

  // تاریخ مشترک
  const ERR_TXT='لطفاً تاریخ را با فرمت درست وارد کنید.';
  const keyDMY=(d,m,y)=>`${y}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`;
  const validDMY=s=>/^\d{2}\/\d{2}\/\d{4}$/.test(s)&&moment.from(keyDMY(...s.split('/').map(Number)),'fa','jYYYY/jMM/jDD').isValid();
  const DMYtoYMD=s=>{const [d,m,y]=s.split("/").map(Number);return keyDMY(d,m,y);};
  function validateRange(from,to){
    if(!validDMY(from)||!validDMY(to)) return null;
    const mFrom=moment.from(DMYtoYMD(from),'fa','jYYYY/jMM/jDD');
    const mTo  =moment.from(DMYtoYMD(to)  ,'fa','jYYYY/jMM/jDD');
    const today=moment();
    if(mFrom.isAfter(today) || mTo.isAfter(today)) return null;
    if(mTo.isBefore(mFrom)) return null;
    return {mFrom,mTo};
  }
  function showErr(msg){const e=document.getElementById('errBox'); e.style.display='block'; e.textContent=msg;}

  // تولتیپ/مودال آیتم‌ها
  const tooltip=document.getElementById('tooltipx');
  function showTip(ev, items){ if(!items || !items.length){ hideTip(); return; } tooltip.innerHTML = items.slice(0,8).map(t=>`• ${t||'—'}`).join('<br>'); tooltip.style.display='block'; moveTip(ev); }
  function moveTip(ev){ tooltip.style.left=(ev.clientX+12)+'px'; tooltip.style.top=(ev.clientY+12)+'px'; }
  function hideTip(){ tooltip.style.display='none'; }

  const itemsModal=document.getElementById('itemsModal'), itemsBody=document.getElementById('itemsBody'), itemsTitle=document.getElementById('itemsTitle');
  function openItemsModal(title, items){
    itemsTitle.textContent = title||'جزئیات';
    itemsBody.innerHTML = (items && items.length)
      ? items.map(t=>`<div class="border-bottom py-2">${t||'—'}</div>`).join('')
      : '<div class="text-muted">موردی وجود ندارد.</div>';
    itemsModal.style.display='block'; dim.style.display='block';
  }
  function closeItems(){ itemsModal.style.display='none'; dim.style.display='none'; }
  window.closeItems=closeItems;

  function makeChip(html, items, titleForModal){
    const span=document.createElement('span'); span.className='chip'; span.innerHTML=html;
    span.addEventListener('mouseenter',(ev)=>showTip(ev,items||[]));
    span.addEventListener('mousemove',moveTip);
    span.addEventListener('mouseleave',hideTip);
    span.addEventListener('click',()=>openItemsModal(titleForModal||'جزئیات', items||[]));
    return span;
  }

  function setMiniBars(ids,arr){ ids.forEach((id,i)=>document.getElementById(id).style.width=Math.max(0,Math.min(100,arr[i]))+'%'); }
  function setMiniBarTexts(ids,arr){ ids.forEach((id,i)=>document.getElementById(id).textContent=Math.max(0,Math.min(100,arr[i]))+'%'); }

  // مشاهده کلی
  document.getElementById('rangeBtn').addEventListener('click', async ()=>{
    document.getElementById('errBox').style.display='none';
    const rBox=document.getElementById('rangeResult'), sBox=document.getElementById('rangeSummary');
    const from=document.getElementById('fromDate').value.trim(), to=document.getElementById('toDate').value.trim();
    document.getElementById('dailyResult').style.display='none';
    const v=validateRange(from,to); if(!v){ showErr(ERR_TXT); rBox.style.display='none'; return; }

    // نمایش loading
    sBox.innerHTML='<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">در حال بارگذاری...</span></div></div>';
    rBox.style.display='block';

    const buckets={ok:[],warn:[],del:[],def:[]};
    const c=v.mFrom.clone();
    while(c.isSameOrBefore(v.mTo)){
      const ymd=c.format('jYYYY/jMM/jDD'); 
      const items=await read(ymd), dels=await readDeleted(ymd), defs=await readPostponed(ymd);
      items.forEach(it => (it.completed || it.done ? buckets.ok : buckets.warn).push({dateYMD:ymd,text:it.text}));
      (dels||[]).forEach(d=>buckets.del.push({dateYMD:ymd,text:d.text}));
      (defs||[]).forEach(p=>buckets.def.push({dateYMD:ymd,text:p.text}));
      c.add(1,'day');
    }
    const total = buckets.ok.length+buckets.warn.length+buckets.del.length+buckets.def.length;
    const pct = n => total? Math.round(n/total*100) : 0;

    rBox.style.display='block';
    // چیپ‌های خلاصه با هابر/کلیک
    sBox.innerHTML='';
    sBox.appendChild(makeChip(`<strong>کل</strong>: ${total}`, [].concat(buckets.ok,buckets.warn,buckets.del,buckets.def).map(x=>x.text), 'کل آیتم‌ها'));
    sBox.appendChild(makeChip(`<span class="dot dot-ok"></span>انجام‌شده: <strong>${buckets.ok.length}</strong>`, buckets.ok.map(x=>x.text), 'انجام‌شده‌ها'));
    sBox.appendChild(makeChip(`<span class="dot dot-warn"></span>انجام‌نشده: <strong>${buckets.warn.length}</strong>`, buckets.warn.map(x=>x.text), 'انجام‌نشده‌ها'));
    sBox.appendChild(makeChip(`<span class="dot dot-del"></span>حذف‌شده: <strong>${buckets.del.length}</strong>`, buckets.del.map(x=>x.text), 'حذف‌شده‌ها'));
    sBox.appendChild(makeChip(`<span class="dot dot-def"></span>موکول‌شده: <strong>${buckets.def.length}</strong>`, buckets.def.map(x=>x.text), 'موکول‌شده‌ها'));

    setMiniBars(['bmOk','bmWarn','bmDel','bmDef'], [pct(buckets.ok.length), pct(buckets.warn.length), pct(buckets.del.length), pct(buckets.def.length)]);
    setMiniBarTexts(['bmOkTxt','bmWarnTxt','bmDelTxt','bmDefTxt'], [pct(buckets.ok.length), pct(buckets.warn.length), pct(buckets.del.length), pct(buckets.def.length)]);
  });

  // جزئیات روزانه (چیپ‌ها با هابر/کلیک)
  document.getElementById('dailyBtn').addEventListener('click', async ()=>{
    document.getElementById('errBox').style.display='none';
    const dWrap=document.getElementById('dailyResult'), dLists=document.getElementById('dailyLists');
    const from=document.getElementById('fromDate').value.trim(), to=document.getElementById('toDate').value.trim();
    const v=validateRange(from,to); if(!v){ showErr(ERR_TXT); dWrap.style.display='none'; return; }
    document.getElementById('rangeResult').style.display='none';

    // نمایش loading
    dLists.innerHTML='<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">در حال بارگذاری...</span></div></div>';
    dWrap.style.display='block';
    
    // پاک کردن loading و شروع بارگذاری داده‌ها
    dLists.innerHTML='';
    
    const c=v.mFrom.clone();
    while(c.isSameOrBefore(v.mTo)){
      const ymd=c.format('jYYYY/jMM/jDD'); 
      const items=await read(ymd), dels=await readDeleted(ymd), defs=await readPostponed(ymd);
      const done=items.filter(i=>(i.completed || i.done)).map(i=>i.text);
      const undone=items.filter(i=>(!i.completed && !i.done)).map(i=>i.text);
      const delc=(dels||[]).map(d=>d.text);
      const defc=(defs||[]).map(d=>d.text);
      const total = done.length+undone.length+delc.length+defc.length;
      const pct = n => total ? Math.round(n/total*100) : 0;

      const card=document.createElement('div'); card.className='day-card';
      const title=document.createElement('div'); title.className='day-title'; title.innerHTML=`<span>${c.locale('fa').format('dddd jD jMMMM')}</span><span class="badge-soft"><strong>کل</strong>: ${total}</span>`;

      // چیپ‌های روزانه با تولتیپ/مودال
      const chips=document.createElement('div'); chips.className='d-flex flex-wrap gap-2 mt-2';
      chips.appendChild(makeChip(`<span class="dot dot-ok"></span> انجام‌شده: <strong>${done.length}</strong>`, done, 'انجام‌شده‌ها — '+c.locale('fa').format('jD jMMMM')));
      chips.appendChild(makeChip(`<span class="dot dot-warn"></span> انجام‌نشده: <strong>${undone.length}</strong>`, undone, 'انجام‌نشده‌ها — '+c.locale('fa').format('jD jMMMM')));
      chips.appendChild(makeChip(`<span class="dot dot-del"></span> حذف‌شده: <strong>${delc.length}</strong>`, delc, 'حذف‌شده‌ها — '+c.locale('fa').format('jD jMMMM')));
      chips.appendChild(makeChip(`<span class="dot dot-def"></span> موکول‌شده: <strong>${defc.length}</strong>`, defc, 'موکول‌شده‌ها — '+c.locale('fa').format('jD jMMMM')));

      const bars=document.createElement('div'); bars.className='mt-2';
      bars.innerHTML=`
        <div class="stat-row"><span class="chip"><span class="dot dot-ok"></span>انجام‌شده</span><div class="bar-mini"><span class="bm-ok" style="width:${pct(done.length)}%"></span></div><span class="mini">${pct(done.length)}%</span></div>
        <div class="stat-row"><span class="chip"><span class="dot dot-warn"></span>انجام‌نشده</span><div class="bar-mini"><span class="bm-warn" style="width:${pct(undone.length)}%"></span></div><span class="mini">${pct(undone.length)}%</span></div>
        <div class="stat-row"><span class="chip"><span class="dot dot-del"></span>حذف‌شده</span><div class="bar-mini"><span class="bm-del" style="width:${pct(delc.length)}%"></span></div><span class="mini">${pct(delc.length)}%</span></div>
        <div class="stat-row"><span class="chip"><span class="dot dot-def"></span>موکول‌شده</span><div class="bar-mini"><span class="bm-def" style="width:${pct(defc.length)}%"></span></div><span class="mini">${pct(defc.length)}%</span></div>
      `;

      card.appendChild(title); card.appendChild(chips); card.appendChild(bars);
      dLists.appendChild(card);
      c.add(1,'day');
    }
  });
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .catch(err => console.log('SW register failed:', err));
    });
  }
</script>

<script>
(async function () {
  // تاریخ امروز به شمسی (هم‌سو با بقیه صفحات تو)
  const todayKey = () => moment().format('jYYYY/jMM/jDD');
  const date = todayKey();

  // --- توابع API (apiGet moved to report section)
  async function apiSave(payload) {
    const headers = window.AuthUtils.getAuthHeaders();
    console.log('API Save Headers:', headers);
    console.log('API Save Payload:', payload);
    
    if (!headers) {
      console.error('No token available for apiSave');
      throw new Error('No authentication token');
    }
    
    const res = await fetch('/api/checklist/save', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(payload),
    });
    
    console.log('API Save Response Status:', res.status);
    if (!res.ok) {
      const errorText = await res.text();
      console.error('API Save Error:', errorText);
      throw new Error('save_failed');
    }
    return res.json();
  }

  // --- خواندن/نوشتن localStorage صفحه چک‌لیست (DISABLED - Use API only)
  const LS_KEY = `tasks-${date}`;
  function readLocal() {
    // Clear localStorage to prevent data mixing
    localStorage.removeItem(LS_KEY);
    return [];
  }
  function writeLocal(items) {
    // Don't write to localStorage to prevent data mixing
    console.log('writeLocal called but disabled to prevent data mixing');
  }

  // --- 1) بارگذاری اولیه از سرور
  (async function initializeChecklist() {
    try {
      console.log('Initializing checklist...');
      
      // بررسی احراز هویت
    if (!window.AuthUtils.isAuthenticated()) {
        console.log('Not authenticated, skipping server load');
      return;
    }
    
      // بارگذاری از سرور
      const server = await apiGet(date);
      console.log('Initial load - Server response:', server);
      
      if (server && Array.isArray(server.items)) {
        console.log('Server response received, rendering items...');
        if (typeof window.refreshUI === 'function') {
          // همیشه refreshUI اجرا کن (حتی اگر آیتمی نباشد)
          window.refreshUI(server.items);
          console.log('Initial load completed, no auto-sync');
        }
      } else {
        console.log('Server response invalid, showing empty message');
        if (typeof window.refreshUI === 'function') {
          window.refreshUI([]);
        }
      }
    } catch (e) {
      console.log('Initial load failed:', e);
      console.log('Initial load completed, no auto-sync');
    }
  })();

  // --- 2) سینک به سرور
  async function syncToServer() {
    try {
      console.log('=== SYNC TO SERVER START ===');
      console.log('Date:', date);
      
      // بررسی وجود تابع collect
      if (typeof window.collect !== 'function') {
        console.error('window.collect function not found!');
        return;
      }
      
      // دریافت آیتم‌ها از DOM
      const items = window.collect();
      console.log('Items to sync:', items);
      console.log('Items count:', items.length);
      
      // اگر آیتمی وجود ندارد، سینک نکن
      if (items.length === 0) {
        console.log('No items to sync, skipping...');
        return;
      }
      
      const payload = { date, items, deleted: [], postponed: [] };
      console.log('Full payload:', payload);
      
      await apiSave(payload);
      console.log('Successfully synced to server');
      console.log('=== SYNC TO SERVER END ===');
    } catch (e) {
      console.error('Sync failed:', e);
    }
  }

  // در اختیار بقیه کدها بگذار که هر جا دیتای چک‌لیست را تغییر می‌دهند، این را صدا بزنند:
  window.timoSyncChecklist = syncToServer;
  window.collect = collect; // در دسترس قرار دادن تابع collect
  
  // استراتژی جدید: فقط سینک دستی
  // هیچ سینک خودکار نداشته باشیم
  window.timoSyncChecklist = function() {
    console.log('Manual sync requested');
    return syncToServer();
  };
  
  // دکمه بازگشت اضافی حذف شد - دکمه موجود کافی است
  
  // تابع تست برای اضافه کردن آیتم
  window.testAddItem = function(text = 'تست آیتم') {
    console.log('Adding test item:', text);
    const li = makeItem({id: crypto.randomUUID(), text: text, done: false});
    list.insertBefore(li, [...list.children].find(x => x.classList.contains('done')) || null);
    li.querySelector('.txt').focus();
    save();
    refreshProgress();
    console.log('Test item added, no auto-sync');
  };

  // هیچ سینک خودکار نداشته باشیم
})();
</script>

</body>
</html>
